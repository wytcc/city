{"version":3,"sources":["webpack:///./static/js/src/index/index.js","webpack:///./static/js/src/index/leafletmap.js","webpack:///./static/js/src/index/sankey.js","webpack:///./static/js/src/index/nodesProducer.js","webpack:///./static/js/src/index/linksProducer.js","webpack:///./static/js/src/index/coordinates.js","webpack:///./static/js/src/index/pixelmap.js"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH,GAAE;AACF;AACA;AACA;AACA;AACA;AACA,SAAQ;AACR,KAAI;AACJ;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA,IAAG;AACH;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH,gDAA+C;AAC/C;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA,MAAK;AACL;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;;AAEA,EAAC,E;;;;;;;AChOD;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA,uBAAsB,EAAE,kCAAkC,EAAE,EAAE,EAAE,EAAE,EAAE;AACpE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAQ;AACR;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA,GAAE;AACF;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA,OAAM;AACN;AACA,KAAI;AACJ;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAQ;AACR,QAAO;AACP,2BAA0B;AAC1B,OAAM;;AAEN;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA,GAAE;AACF;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ,IAAG;AACH,uBAAsB;AACtB,GAAE;AACF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA,IAAG;AACH,GAAE;AACF;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA,IAAG;AACH,GAAE;AACF;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;;AAEA,KAAI;AACJ;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA,GAAE;AACF;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,GAAE;;AAEF;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA,KAAI;AACJ;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA,IAAG;AACH;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;;AAEJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA,KAAI;AACJ;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,MAAK;;AAEL,KAAI;;AAEJ;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL,KAAI;;AAEJ;;AAEA,GAAE;;AAEF;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA,GAAE;AACF;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gBAAe,qBAAqB;AACpC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ,IAAG;;AAEH;AACA;AACA;AACA;AACA,IAAG;;AAEH;;AAEA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH,0DAAyD,gCAAgC,EAAE;AAC3F;AACA;;AAEA;AACA;AACA;AACA,gBAAe,qBAAqB;AACpC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0BAAyB,aAAa,EAAE;AACxC,0BAAyB,aAAa,EAAE;AACxC;AACA;AACA;AACA,IAAG;AACH;;AAEA;AACA;AACA;AACA,iBAAgB,kBAAkB;AAClC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0BAAyB,aAAa,EAAE;AACxC,0BAAyB,aAAa,EAAE;AACxC;AACA;AACA;AACA,IAAG;AACH,GAAE;AACF;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA,GAAE;AACF;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAM;AACN;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;;AAEH;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA,IAAG;AACH;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAgB;AAChB,SAAQ;AACR;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,6B;;;;;;AC59BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ,IAAG;AACH;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,IAAG;AACH;AACA,GAAE;;AAEF;AACA,iBAAgB,oBAAoB;AACpC;AACA,kBAAiB,gBAAgB;AACjC;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,iBAAgB,oBAAoB;AACpC;AACA,kBAAiB,gBAAgB;AACjC;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,iBAAgB,QAAQ;AACxB;AACA;AACA;;AAEA;AACA,iBAAgB,QAAQ;AACxB;AACA;AACA;;AAEA;AACA,iBAAgB,QAAQ;AACxB;AACA;AACA;AACA,iBAAgB,QAAQ;AACxB;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA,KAAI;AACJ;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAQ;AACR,QAAO;AACP;AACA;AACA;AACA,OAAM;AACN;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ,IAAG;AACH,uBAAsB;AACtB,GAAE;AACF;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,iBAAgB,iBAAiB;AACjC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;;AAEA;AACA;AACA,KAAI;AACJ;;AAEA;AACA;AACA;AACA;AACA;AACA,iBAAgB,QAAQ;AACxB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB,mBAAmB;AACpC;AACA,mBAAkB,oBAAoB;AACtC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA,IAAG;AACH;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF,iBAAgB,kBAAkB;AAClC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gCAA+B,QAAQ;AACvC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,IAAG;AACH;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA,GAAE;AACF,iCAAgC,QAAQ;AACxC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;;AAEA,yB;;;;;;ACjxBA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAsB,gBAAgB;AACtC;AACA,2BAA0B,iBAAiB;AAC3C;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;;;;;;;ACnCA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAsB,gBAAgB;AACtC;AACA,2BAA0B,oBAAoB;AAC9C;AACA;AACA,6CAA4C,yBAAyB;AACrE;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA,EAAC;;AAED;;;;;;;ACjCA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA,oBAAmB,yFAAyF;AAC5G;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,G;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,GAAE;AACF;AACA;AACA,gBAAe,eAAe;AAC9B;AACA;AACA,kBAAiB,aAAa;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA,MAAK;AACL;AACA;AACA;AACA,KAAI;AACJ,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA,OAAM;AACN;AACA;AACA,MAAK;AACL;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA,sBAAqB,OAAO;AAC5B;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAM;;AAEN;AACA,gCAA+B,QAAQ;AACvC;AACA;AACA;;AAEA;AACA;AACA;AACA,gCAA+B,QAAQ;AACvC;AACA;AACA;AACA;AACA;AACA;AACA,0BAAyB;AACzB;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,eAAc,eAAe;AAC7B;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa,QAAQ;AACrB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa,oBAAoB;AACjC;AACA;AACA;AACA;;AAEA;AACA;AACA,cAAa,aAAa;AAC1B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,oBAAmB,QAAQ;AAC3B;AACA;AACA;AACA;AACA;AACA;AACA,OAAM;AACN;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,aAAY,eAAe;AAC3B;AACA;AACA;AACA;AACA;AACA;AACA,uBAAsB,QAAQ;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;;AAEA;AACA,wBAAuB,uCAAuC;AAC9D;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,yB;;;;;;ACjYA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,oBAAmB,iBAAiB;AACpC;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAU;AACV,OAAM;AACN,UAAS;AACT;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,YAAW;AACX,OAAM;AACN,UAAS;AACT;AACA;AACA;AACA,MAAK;;AAEL;AACA,sBAAqB,iBAAiB;AACtC;AACA;AACA;AACA,aAAY;AACZ;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAM;AACN,oBAAmB,qBAAqB;AACxC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA,6BAA4B,UAAU,EAAE;AACxC;AACA,qCAAoC,qBAAqB,EAAE;AAC3D;AACA;AACA;AACA,+BAA8B,UAAU,EAAE;AAC1C;;AAEA;;AAEA;AACA;AACA,uDAAsD,cAAc,EAAE;AACtE;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAM;AACN;AACA;AACA,OAAM;AACN;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAQ;AACR;AACA;AACA,OAAM;AACN;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA,OAAM;;AAEN,mEAAkE,cAAc,EAAE;AAClF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA6B,yBAAyB,EAAE;AACxD,iCAAgC,cAAc,EAAE;AAChD;AACA;AACA;AACA;AACA;AACA,oCAAmC,2BAA2B;AAC9D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA;AACA,QAAO;AACP;AACA;AACA;AACA,QAAO;AACP;AACA,0BAAyB,eAAe;AACxC;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,mCAAkC,kBAAkB,EAAE;AACtD;AACA,kCAAiC,qBAAqB,EAAE;AACxD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAwC,sBAAsB,EAAE;AAChE;AACA,wCAAuC,qBAAqB,EAAE;AAC9D;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,0BAAyB,wBAAwB,EAAE;AACnD;AACA,kCAAiC,wBAAwB,EAAE;AAC3D;AACA,kCAAiC,qBAAqB,EAAE;AACxD;AACA;AACA;;AAEA;AACA,WAAU;AACV,eAAc;AACd,cAAa;AACb;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,IAAG;;AAEH;;AAEA;AACA;;AAEA;;AAEA;;AAEA","file":"index.js","sourcesContent":["/**\n * Created by huwanqi on 2016/3/15.\n */\nvar util = require(\"util\");\nvar Leafletmap = require(\"leafletmap\");\nvar Sankey = require(\"sankey\");\nvar coordinates = require(\"coordinates\");\nvar pixelmap = require(\"pixelmap\");\n\n$(document).ready(function() {\n\t//\tset pixelmap graph legend\n\t$(\"#pixelmap-legend .item\").each(function(d, dom) {\n\t\tvar move = $(dom).attr(\"data\");\n\t\t$(dom).css({\n\t\t\tbackground: \"rgb(227, 26, 28)\",\n\t\t\topacity: move\n\t\t});\n\t});\n\t//\tset sankey graph legend\n\t$(\"#sankey-legend1 .item\").each(function(d, dom) {\n\t\tvar move = $(dom).attr(\"data\");\n\t\t$(dom).css({\n\t\t\tbackground: \"#75DAB3\",\n\t\t\topacity: util.opacityScale(move)\n\t\t});\n\t});\n\t//$(\"#sankey-legend2 .item\").each(function(d, dom){\n\t//    var headcount = $(dom).attr(\"data\");\n\t//    $(dom).css({\n\t//        background: \"#75DAB3\",\n\t//        height: headcount\n\t//    });\n\t//});\n\t//初始化地图\n\tvar leafletmap = new Leafletmap(\"#index-map\");\n\t//初始化sankey图\n\tvar sankey = new Sankey(\"#index-sankey\");\n\n//\tset interaction\n\tsankey.leafletmap = leafletmap;\n\tleafletmap.sankey = sankey;\n\n\t//初始化平行坐标\n\tcoordinates(\"#index-pcoordinates\");\n\t//初始化像素图\n\tpixelmap(\"#index-pixelmap\", leafletmap, sankey);\n\n\t$(\"body\").on(\"dblclick\", \"#index-sankey svg, #pixdiv, \" +\n\t\t\"#index-pcoordinates svg\",\n\t\tfunction() {\n\t\t\tif (!sankey.locked) {\n\t\t\t\tresetWithoutLock();\n\t\t\t}\n\t\t});\n\n\tdocument.onselectstart = function() {\n\t\treturn false;\n\t};\n\n\t//\t桑葚图的时间刷点击\n\t$(\".timeBrush span\").on(\"click\", function() {\n\t\t//var brushSwitch = $(this).find(\".glyphicon\");\n\t\t//if(brushSwitch.hasClass(\"glyphicon-remove\")){\n\t\t//    $(this).removeClass(\"btn-danger\");\n\t\t//    $(this).addClass(\"btn-success\");\n\t\t//    brushSwitch.removeClass(\"glyphicon-remove\");\n\t\t//    brushSwitch.addClass(\"glyphicon-ok\");\n\t\t//    sankey.addBrush();\n\t\t//}else{\n\t\t//    $(this).addClass(\"btn-danger\");\n\t\t//    $(this).removeClass(\"btn-success\");\n\t\t//    brushSwitch.removeClass(\"glyphicon-ok\");\n\t\t//    brushSwitch.addClass(\"glyphicon-remove\");\n\t\t//    sankey.clearBrush();\n\t\t//    var pTrac = leafletmap.getPTrac();\n\t\t//    leafletmap.drawPTrajectory(pTrac);\n\t\t//}\n\t\tif ($(\".timeBrush\").hasClass(\"selected\")) {\n\t\t\t$(\".timeBrush\").removeClass(\"selected\");\n\t\t\tsankey.clearBrush();\n\t\t\tvar pTrac = leafletmap.getPTrac();\n\t\t\tleafletmap.drawPTrajectory(pTrac);\n\t\t\treturn false;\n\t\t}\n\t\tif (!$(this).find(\"span\").hasClass(\"disable\")) {\n\t\t\tsankey.addBrush();\n\t\t\t$(\".timeBrush\").addClass(\"selected\");\n\t\t\treturn false;\n\t\t}\n\t});\n\n\t$(\".btn.clear\").on(\"click\", function() {\n\t\tresetWithLock();\n\t\t$(\".multiChoose\").removeClass(\"clicked\");\n\t\t$(\".regionBrush\").removeClass(\"clicked\");\n\t\tsankey.setMultiChooseMode(false);\n\t\t$(\"#index-sidebar .tips\").hide();\n\t\t$(\"#index-sidebar .result\").hide();\n\t\tleafletmap.clearBrush();\n\t});\n\n\t$(\".btn.search\").on(\"click\", function() {\n\t\tresetWithoutLock();\n\t\tvar id = $(\"input.peopleID\").val();\n\t\t//var testID = \"460005876051371\";\n\t\tsankey.locked = 1;\n\t\t$.ajax({\n\t\t\ttype: 'GET',\n\t\t\turl: util.urlBase + '/getPersonPath',\n\t\t\tdata: {\n\t\t\t\tid: id\n\t\t\t},\n\t\t\tsuccess: function(data) {\n\t\t\t\tif (data.length == 0) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tvar userid = JSON.parse(JSON.parse(data[0].userid));\n\t\t\t\tvar path = JSON.parse(JSON.parse(data[0].clusters));\n\t\t\t\tsankey.drawPeoplePath(path, userid);\n\t\t\t},\n\t\t\terror: function(data) {\n\t\t\t\tconsole.log(data);\n\t\t\t}\n\t\t});\n\t\tcoordinates(\"#index-pcoordinates\", 0, 0, id);\n\t\t$.ajax({\n\t\t\ttype: 'GET',\n\t\t\turl: util.urlBase + '/getPersonTrac',\n\t\t\tdata: {\n\t\t\t\tid: id\n\t\t\t},\n\t\t\tsuccess: function(data) {\n\t\t\t\tif (data.length == 0) {\n\t\t\t\t\t$(\"#index-sidebar .tips\").show();\n\t\t\t\t\t$(\"#index-sidebar .result\").hide();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tleafletmap.drawPTrajectory(data);\n\t\t\t\t$(\"#index-sidebar .tips\").hide();\n\t\t\t\t$(\"#index-sidebar .result\").show();\n\t\t\t\tvar html = '<tr class=\"item\"> <td>1</td> <td class=\"userid\">' + data[0].userid + '</td> <td>[' + data[0].HomeLocX.toFixed(2) + ', ' + data[0].HomeLocY.toFixed(2) + ']</td> </tr>';\n\t\t\t\t$(\"#index-sidebar .result table tbody\").html(html);\n\t\t\t\t$(\".btn.showMore\").hide();\n\t\t\t},\n\t\t\terror: function(data) {\n\t\t\t\tconsole.log(data);\n\t\t\t}\n\t\t});\n\t\t$(\".timeBrush span\").removeClass(\"disable\");\n\t});\n\n\t$(\"body\").on(\"click\", \".result table .item\", function() {\n\t\td3.selectAll(\".track\").attr(\"stroke-width\", 2).attr(\"stroke\", util.transitionColor);\n\t\tif ($(this).hasClass(\"success\")) {\n\t\t\t$(this).removeClass(\"success\");\n\t\t\t//$(\".timeBrush.btn\").hide();\n\t\t\t$(\".timeBrush span\").addClass(\"disable\");\n\t\t\t//TODO\n\t\t} else {\n\t\t\t$(\".timeBrush span\").removeClass(\"disable\"); //enable time brush\n\t\t\t$(\".result table .item\").removeClass(\"success\");\n\t\t\t$(this).addClass(\"success\");\n\t\t\tvar userid = $(this).find(\".userid\").html();\n\t\t\td3.selectAll(\".track[userid='\" + userid + \"']\").attr(\"stroke-width\", 6).attr(\"stroke\", util.ptransitionColorHighlight);\n\t\t\td3.selectAll(\".track[userid='\" + userid + \"']\").each(function() {\n\t\t\t\tthis.parentNode.appendChild(this);\n\t\t\t});\n\t\t\tleafletmap.setHomeLocs(null);\n\t\t\t//draw this person's trajectory\n\t\t\t$.ajax({\n\t\t\t\ttype: 'GET',\n\t\t\t\turl: util.urlBase + '/getPersonTrac',\n\t\t\t\tdata: {\n\t\t\t\t\tid: userid\n\t\t\t\t},\n\t\t\t\tsuccess: function(data) {\n\t\t\t\t\tleafletmap.drawPTrajectory(data);\n\t\t\t\t},\n\t\t\t\terror: function(data) {\n\t\t\t\t\tconsole.log(data);\n\t\t\t\t}\n\t\t\t});\n\t\t\tcoordinates(\"#index-pcoordinates\", 0, 0, userid);\n\t\t}\n\t});\n\n\tfunction resetWithoutLock() {\n\t\td3.selectAll(\".nodeGroup rect\").attr(\"stroke\", \"white\");\n\t\td3.selectAll(\".linkGroup .link\").attr(\"opacity\", 0.8);\n\t\tleafletmap.clearTrajectory();\n\t\td3.selectAll(\".nodeGroup rect\").each(function() {\n\t\t\tvar move = d3.select(this).attr(\"move\");\n\t\t\td3.select(this).attr(\"opacity\", util.opacityScale(move)).classed(\"selected\", false).classed(\"selected2th\", false);\n\t\t});\n\t\t//初始化平行坐标\n\t\td3.selectAll(\"g.nodeGroup polygon\").remove();\n\t\td3.selectAll(\"g.flowGroup polygon\").attr(\"visibility\", \"hidden\");\n\t\tcoordinates(\"#index-pcoordinates\");\n\t\tpixelmap(\"#index-pixelmap\", leafletmap, sankey);\n\t}\n\n\tfunction resetWithLock() {\n\t\t$(\"input.peopleID\").val(\"\");\n\t\tsankey.locked = 0;\n\t\t//清空一个人的转移轨迹\n\t\t$(\".timeBrush\").removeClass(\"selected\")\n\t\t$(\".timeBrush span\").addClass(\"disable\");\n\t\t$(\".track\").remove();\n\t\tsankey.clearBrush();\n\t\td3.selectAll(\".nodeGroup rect\").attr(\"stroke\", \"white\");\n\t\td3.selectAll(\".linkGroup .link\").attr(\"opacity\", 0.8);\n\t\tleafletmap.clearTrajectory();\n\t\t//d3.selectAll(\".nodeGroup rect\").attr(\"opacity\", 1).classed(\"selected\", false).classed(\"selected2th\", false);\n\t\td3.selectAll(\".nodeGroup rect\").each(function() {\n\t\t\tvar move = d3.select(this).attr(\"move\");\n\t\t\td3.select(this).attr(\"opacity\", util.opacityScale(move)).classed(\"selected\", false).classed(\"selected2th\", false);\n\t\t});\n\t\t//初始化平行坐标\n\t\td3.selectAll(\"g.nodeGroup polygon\").remove();\n\t\td3.selectAll(\"g.flowGroup polygon\").attr(\"visibility\", \"hidden\");\n\t\tcoordinates(\"#index-pcoordinates\");\n\t\tpixelmap(\"#index-pixelmap\", leafletmap, sankey);\n\t}\n\n});\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./static/js/src/index/index.js\n ** module id = 0\n ** module chunks = 1\n **/","/**\n * Created by huwanqi on 2016/3/21.\n */\nvar util = require(\"util\");\n\nvar map;\nvar trajectoryGroup;\nvar container;\nvar distanceThreshold = 100;\nvar mapSvgDom = '#mapSvg';\nvar cList = [];\nvar cList1 = [];\nvar now = 0;\nvar pList = [];\nvar vertices = [];\nvar vertices2 = [];\nvar homeLoc;\nvar homeLocs;\n\nvar brushMode = false;\n\nvar pTrac = null;\n\n//加载更多按钮所用变量\nvar getPeopleHomeResults;\nvar getPeopleHomeIndex;\n\nvar corner1, corner2, boundRect;\n\nvar leafletmap = function(dom) {\n\tcontainer = dom;\n\tthis.render();\n};\n\nvar prototype = leafletmap.prototype;\n\nprototype.render = function() {\n\tvar that = this;\n\tvar id = $(container).attr(\"id\");\n\t//initialize map\n\t//\t在div中创造map,设置地图中心和缩放级别\n\tmap = L.map(id, {\n\t\tzoomControl: false,\n\t\tminZoom: 10,\n\t\tmaxZoom: 16\n\t\t\t//\t浙江台州市温岭附近\n\t}).setView([28.38, 121.21], 16);\n\t$(\".leaflet-bottom.leaflet-right\").remove()\n\t\t//\t添加一个街道的图层\n\tL.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png').addTo(map);\n\tmap.fitBounds([\n\t\t[27.846675, 120.53695],\n\t\t[28.162664, 120.900696]\n\t]);\n\tmap.doubleClickZoom.disable();\n\t/*\n\t 添加刷选按钮\n\t */\n\t//var ourCustomControl = L.Control.extend({\n\t//    options: {\n\t//        position: 'topleft'\n\t//    },\n\t//    onAdd: function (map) {\n\t//        var container = L.DomUtil.create('div', 'leaflet-brush leaflet-bar leaflet-control');\n\t//        $(container).attr(\"title\", \"brush\");\n\t//        $(container).html('<img src=\"./static/images/rect1.png\">');\n\t//\n\t//        container.onclick = function(){\n\t//            $(container).addClass(\"clicked\");\n\t//            brushMode = true;\n\t//            map.dragging.disable();\n\t//        };\n\t//        return container;\n\t//    }\n\t//});\n\t//map.addControl(new ourCustomControl());\n\n\t//选择地图区域\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t$(\".regionBrush\").on(\"click\", function() {\n\t\tif($(this).hasClass(\"clicked\")) {\n\t\t\t$(this).removeClass(\"clicked\");\n\t\t\tbrushMode = false;\n\t\t\tmap.dragging.enable();\n\t\t} else {\n\t\t\t$(this).addClass(\"clicked\");\n\t\t\tbrushMode = true;\n\t\t\tmap.dragging.disable();\n\t\t}\n\t});\n\n\t//显示地图使用帮助\n\t$(\".showTips\").on(\"click\", function() {\n\t\t$(\".mapTips\").show();\n\t\tsetTimeout(function() {\n\t\t\t$(\".mapTips\").fadeOut();\n\t\t}, 5000);\n\t});\n\n\tmap.on(\"movestart\", function() {\n\t\t$(\"#mapSvg\").hide();\n\t});\n\tmap.on(\"moveend\", function() {\n\t\tthat.updateSvg();\n\t\t$(\"#mapSvg\").show();\n\t});\n\t//缩放\n\tmap.on(\"zoomstart\", function() {\n\t\t$(\"#mapSvg\").hide();\n\t});\n\tmap.on(\"zoomend\", function() {\n\t\tthat.updateSvg();\n\t\t$(\"#mapSvg\").show();\n\t});\n\t//鼠标移到元素上并按下键\n\tmap.on(\"mousedown\", function(ev) {\n\t\tev.originalEvent.preventDefault();\n\t\tif(brushMode) {\n\t\t\tresetBrush();\n\t\t\tresetSvg();\n\t\t\tcorner1 = ev.latlng;\n\t\t\t//鼠标移动的位置\n\t\t\tmap.on(\"mousemove\", function(ev2) {\n\t\t\t\tcorner2 = ev2.latlng;\n\t\t\t\tvar bounds = [corner1, corner2];\n\t\t\t\tif(boundRect) {\n\t\t\t\t\tboundRect.setBounds(bounds);\n\t\t\t\t} else {\n\t\t\t\t\tboundRect = L.rectangle(bounds, {\n\t\t\t\t\t\tfillOpacity: 0.1,\n\t\t\t\t\t\tcolor: \"#ff7800\",\n\t\t\t\t\t\tweight: 1\n\t\t\t\t\t}).addTo(map);\n\t\t\t\t}\n\t\t\t});\n\t\t\t//鼠标移动结束后点的位置\n\t\t\tmap.on(\"mouseup\", function(ev3) {\n\t\t\t\tmap.off(\"mousemove\");\n\t\t\t\tmap.off(\"mouseup\");\n\n\t\t\t\tcorner2 = ev3.latlng;\n\t\t\t\tvar bounds = [corner1, corner2];\n\t\t\t\tif(boundRect) {\n\t\t\t\t\tvar lat_max = bounds[0].lat > bounds[1].lat ? bounds[0].lat : bounds[1].lat;\n\t\t\t\t\tvar lat_min = bounds[0].lat < bounds[1].lat ? bounds[0].lat : bounds[1].lat;\n\t\t\t\t\tvar lng_max = bounds[0].lng > bounds[1].lng ? bounds[0].lng : bounds[1].lng;\n\t\t\t\t\tvar lng_min = bounds[0].lng < bounds[1].lng ? bounds[0].lng : bounds[1].lng;\n\n\t\t\t\t\t$.ajax({\n\t\t\t\t\t\ttype: 'get',\n\t\t\t\t\t\turl: util.urlBase + '/getPeopleHome',\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tlongitude1: lng_min,\n\t\t\t\t\t\t\tlongitude2: lng_max,\n\t\t\t\t\t\t\tlatitude1: lat_min,\n\t\t\t\t\t\t\tlatitude2: lat_max,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsuccess: function(data) {\n\t\t\t\t\t\t\t$(\"#index-sidebar .tips\").hide();\n\t\t\t\t\t\t\t$(\"#index-sidebar .result\").show();\n\t\t\t\t\t\t\t$(\".timeBrush.btn\").hide();\n\t\t\t\t\t\t\tgetPeopleHomeResults = data;\n\t\t\t\t\t\t\tgetPeopleHomeIndex = 1;\n\t\t\t\t\t\t\t//右侧查询面板增加元素\n\t\t\t\t\t\t\tthat.appendResults();\n\t\t\t\t\t\t\t$(\".btn.showMore\").unbind(\"click\");\n\t\t\t\t\t\t\t$(\".btn.showMore\").on(\"click\", function() {\n\t\t\t\t\t\t\t\tgetPeopleHomeIndex++;\n\t\t\t\t\t\t\t\tif(getPeopleHomeResults.length <= getPeopleHomeIndex * 20) {\n\t\t\t\t\t\t\t\t\t$(\".btn.showMore\").hide();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthat.appendResults();\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t\terror: function() {},\n\t\t\t\t\t});\n\n\t\t\t\t\t$(\".regionBrush\").removeClass(\"clicked\");\n\t\t\t\t\tbrushMode = false;\n\t\t\t\t\tmap.dragging.enable();\n\t\t\t\t\t//brushMode = false;\n\t\t\t\t\t//map.dragging.enable();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n};\n\nprototype.appendResults = function() {\n\tvar that = this;\n\tvar html = '';\n\tvar useridlist = [];\n\tvar homes = [];\n\tif(getPeopleHomeResults.length > getPeopleHomeIndex * 20) {\n\t\t$(\".btn.showMore\").show();\n\t} else {\n\t\t$(\".btn.showMore\").hide();\n\t}\n\tgetPeopleHomeResults.forEach(function(d, i) {\n\t\tif(i >= getPeopleHomeIndex * 20) {\n\t\t\treturn false;\n\t\t}\n\t\t//右边查询面板显示列表\n\t\thtml += '<tr class=\"item\"> <td>' + (i + 1) + '</td> <td class=\"userid\">' + d.userid + '</td> <td>[' + d.homelocx.toFixed(2) + ', ' + d.homelocy.toFixed(2) + ']</td> </tr>';\n\t\tuseridlist.push(d.userid);\n\t\thomes.push([d.homelocy, d.homelocx]);\n\t});\n\tvar useridliststr = useridlist.join('-');\n\t$.ajax({\n\t\ttype: 'get',\n\t\turl: util.urlBase + '/getPeopleByIDs',\n\t\tdata: {\n\t\t\tuseridlist: useridliststr\n\t\t},\n\t\tsuccess: function(data2) {\n\t\t\t//console.log(data2);\n\t\t\tdata2.forEach(function(d) {\n\t\t\t\tvar path = JSON.parse(JSON.parse(d.clusters));\n\t\t\t\t//画桑葚图\n\t\t\t\tthat.sankey.drawPeoplePath(path, d.userid);\n\t\t\t});\n\t\t},\n\t\terror: function() {},\n\t});\n\thomeLocs = homes;\n\t//在地图上面标记家的位置\n\tthis.drawHomes();\n\t$(\"#index-sidebar .result table tbody\").html(html);\n};\n\nprototype.findTrajectory = function(type, time) {\n\tvar that = this;\n\tif(type && time) {\n\t\t$.ajax({\n\t\t\ttype: \"GET\",\n\t\t\turl: util.urlBase + '/getTrajectoryByNode',\n\t\t\tdata: {\n\t\t\t\ttype: type,\n\t\t\t\ttime: time\n\t\t\t},\n\t\t\tsuccess: function(data) {\n\t\t\t\tthat.drawTrajectory(data);\n\t\t\t}\n\t\t});\n\t} else if(type != undefined && !time) {\n\t\t$.ajax({\n\t\t\ttype: \"GET\",\n\t\t\turl: util.urlBase + '/getTrajectoryByType',\n\t\t\tdata: {\n\t\t\t\ttype: type\n\t\t\t},\n\t\t\tsuccess: function(data) {\n\t\t\t\tthat.drawTrajectory(data);\n\t\t\t}\n\t\t});\n\t} else {\n\t\tthat.drawTrajectory([]);\n\t}\n\n};\n\nprototype.drawTrajectory = function(tList, start, end) {\n\tresetSvg();\n\t//\t搜索指定区域\n\tmap.fitBounds([\n\t\t[27.846675, 120.53695],\n\t\t[28.162664, 120.900696]\n\t]);\n\tif(tList.length == 0) {\n\t\tconsole.warn(\"没有轨迹！\");\n\t\treturn false;\n\t}\n\thomeLoc = null;\n\tcList = [];\n\tpList = [];\n\tvertices = [];\n\tvertices2 = [];\n\n\ttList.forEach(function(t, tindex) {\n\t\tif(tindex > 50) {\n\t\t\treturn false;\n\t\t}\n\t\t//轨迹条数限制\n\t\tif(t.distanceid > distanceThreshold) {\n\t\t\treturn false;\n\t\t}\n\t\tvar coordinates = (t.trajectory && JSON.parse(JSON.parse(t.trajectory)));\n\t\t//静止状态\n\t\tif(t.state === 0) {\n\t\t\t//画点\n\t\t\tvar temp = [];\n\t\t\tcoordinates.forEach(function(p, i) {\n\t\t\t\tvar lat = p[1];\n\t\t\t\tvar lng = p[0];\n\t\t\t\t//var time = p[2];\n\t\t\t\t//if(start && end && (time < start || time > end)){\n\t\t\t\t//    return false;\n\t\t\t\t//}\n\t\t\t\tcList.push({\n\t\t\t\t\tlat: lat,\n\t\t\t\t\tlng: lng\n\t\t\t\t});\n\t\t\t\ttemp.push(L.latLng(lat, lng));\n\n\t\t\t});\n\t\t\tvertices2.push(temp);\n\t\t} else {\n\t\t\t//画轨迹\n\t\t\tvar path = [];\n\t\t\tcoordinates.forEach(function(p, i) {\n\t\t\t\tvar lat = p[1];\n\t\t\t\tvar lng = p[0];\n\t\t\t\t//var time = p[2];\n\t\t\t\t//if(start && end && (time < start || time > end)){\n\t\t\t\t//    return false;\n\t\t\t\t//}\n\t\t\t\tpath.push(L.latLng(lat, lng));\n\t\t\t\tvertices.push(L.latLng(lat, lng));\n\t\t\t});\n\t\t\tpList.push(path);\n\t\t}\n\t});\n\tthis.updateSvg();\n};\n\n//画单个人的轨迹，每个人的位置信息，开始，结束时间\nprototype.drawPTrajectory = function(data, start, end) {\n\tconsole.log(\"drawPTrajectory\");\n\tpTrac = data;\n\tresetSvg();\n\t//设置地图的缩放和比例\n\tmap.fitBounds([\n\t\t//浙江省温州市瑞安市前河县\n\t\t[27.846675, 120.53695],\n\t\t//浙江省温州市乐清市双贤路\n\t\t[28.162664, 120.900696]\n\t]);\n\tvar that = this;\n\tif(!data || data.length == 0) {\n\t\tconsole.warn(\"轨迹为空\");\n\t\treturn false;\n\t}\n\thomeLoc = null;\n\tcList = [];\n\tpList = [];\n\tvertices = [];\n\tvertices2 = [];\n\tdata.forEach(function(d, tindex) {\n\n\t\t//add data into CList and path\n\t\tthat.drawAllPTrajectory(d, tindex, start, end);\n\t\t//point into cList1\n\t\t//that.addPointToList1(d, tindex, start, end);\n\n\t});\n\n\thomeLoc = [data[0].HomeLocY, data[0].HomeLocX];\n\n\t//draw clcle and paths\n\tthat.updateSvg();\n\n\t//draw move path\n\tthat.drawMoveProjectory();\n\n};\n\nprototype.drawPointTragectory = function(circle) {\n\tconsole.log(\"drawPointTragectory\");\n\tvar p = map.latLngToContainerPoint([circle.lat, circle.lng]);\n\tvar zoom = map.getZoom();\n\tvar canvas = d3.select(mapSvgDom).select(\".primitives\");\n\tcanvas.append(\"circle\")\n\t\t.attr(\"class\", \"primitive\")\n\t\t.style(\"pointer-events\", \"visiblePainted\")\n\t\t.attr(\"r\", Math.sqrt(zoom) * zoom * 0.1)\n\t\t.attr(\"fill\", \"#000\")\n\t\t//.attr(\"stroke-width\", 1)\n\t\t//.attr(\"stroke\", \"white\")\n\t\t//.attr(\"fill-opacity\", 0.6)\n\t\t.attr(\"transform\", function() {\n\t\t\treturn \"translate(\" + p.x + \",\" + p.y + \")\";\n\t\t});\n};\n\n//prototype.addPointToList1 = function(d, tindex, start, end) {\n//\t//对每个轨迹数据设置停留时间；\n//\tvar coordinates = d.records;\n//\tcoordinates.forEach(function(p, i) {\n//\t\tvar lat = p[1];\n//\t\tvar lng = p[0];\n//\t\tvar time = p[2];\n//\t\t//console.log(new Date(time));\n//\t\tif(start && end && (time < start || time > end)) {\n//\t\t\treturn false;\n//\t\t}\n//\t\t//point to cList1\n//\t\tcList1.push({\n//\t\t\tlat: lat,\n//\t\t\tlng: lng\n//\t\t});\n//\n//\t});\n//\n//};\n\nprototype.drawAllPTrajectory = function(d, tindex, start, end) {\n\n\t//对每个轨迹数据设置停留时间；\n\tif(d.movestate == 1) {\n\t\t//画线\n\t\tvar coordinates = d.records;\n\t\tvar path = [];\n\t\tvar preX = null;\n\t\tvar preY = null;\n\t\tvar startIndex = null;\n\t\tvar endIndex = null;\n\t\tcoordinates.forEach(function(p, i) {\n\t\t\tvar lat = p[1];\n\t\t\tvar lng = p[0];\n\t\t\tvar time = p[2];\n\t\t\t//console.log(new Date(time));\n\t\t\tif(start && end && (time < start || time > end)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif(startIndex != null) {\n\t\t\t\tendIndex = i;\n\t\t\t} else {\n\t\t\t\tstartIndex = i;\n\t\t\t}\n\t\t\t//画路径,以精度和纬度表示地理坐标\n\t\t\tpath.push(L.latLng(lat, lng));\n\t\t\t//\n\t\t\tvertices.push(L.latLng(lat, lng));\n\t\t});\n\n\t\tif(startIndex != null && startIndex > 0) {\n\t\t\t//first\n\t\t\tvar p1 = coordinates[startIndex - 1];\n\t\t\t//second\n\t\t\tvar p2 = coordinates[startIndex];\n\t\t\tvar lng1 = p1[0];\n\t\t\tvar lng2 = p2[0];\n\t\t\tvar lat1 = p1[1];\n\t\t\tvar lat2 = p2[1];\n\t\t\tvar time1 = p1[2];\n\t\t\tvar time2 = p2[2];\n\t\t\tvar scale = d3.scale.linear().range([lat1, lat2]).domain([time1, time2]);\n\t\t\tvar lat = scale(start);\n\t\t\tscale = d3.scale.linear().range([lng1, lng2]).domain([time1, time2]);\n\t\t\tvar lng = scale(start);\n\t\t\t//向数组中添加第一个元素\n\t\t\tpath.unshift(L.latLng(lat, lng));\n\t\t\tvertices.push(L.latLng(lat, lng));\n\t\t}\n\t\tif(endIndex != null && endIndex < coordinates.length - 1) {\n\t\t\t//before last\n\t\t\tvar p1 = coordinates[endIndex];\n\t\t\t//last\n\t\t\tvar p2 = coordinates[endIndex + 1];\n\t\t\tvar lng1 = p1[0];\n\t\t\tvar lng2 = p2[0];\n\t\t\tvar lat1 = p1[1];\n\t\t\tvar lat2 = p2[1];\n\t\t\tvar time1 = p1[2];\n\t\t\tvar time2 = p2[2];\n\t\t\tvar scale = d3.scale.linear().range([lat1, lat2]).domain([time1, time2]);\n\t\t\tvar lat = scale(end);\n\t\t\tscale = d3.scale.linear().range([lng1, lng2]).domain([time1, time2]);\n\t\t\tvar lng = scale(end);\n\t\t\t//移动的线集\n\t\t\tvertices.push(L.latLng(lat, lng));\n\t\t}\n\t\tpList.push(path);\n\n\t} else {\n\t\t//画点\n\t\tvar coordinates = d.records;\n\t\tvar temp = [];\n\t\tcoordinates.forEach(function(p, i) {\n\t\t\tvar lat = p[1];\n\t\t\tvar lng = p[0];\n\t\t\tvar time = p[2];\n\t\t\tif(start && end && (time < start || time > end)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t//point\n\t\t\tcList.push({\n\t\t\t\tlat: lat,\n\t\t\t\tlng: lng\n\t\t\t});\n\t\t\ttemp.push(L.latLng(lat, lng));\n\t\t});\n\t\t//停留的点集\n\t\tvertices2.push(temp);\n\t}\n\n}\n\n//画单个人的轨迹，每个人的位置信息，开始，结束时间\nprototype.drawPTrajectory_origin = function(data, start, end) {\n\tconsole.log(\"drawPTrajectory\");\n\tpTrac = data;\n\tresetSvg();\n\t//设置地图的缩放和比例\n\tmap.fitBounds([\n\t\t[27.846675, 120.53695],\n\t\t[28.162664, 120.900696]\n\t]);\n\tvar that = this;\n\tif(!data || data.length == 0) {\n\t\tconsole.warn(\"轨迹为空\");\n\t\treturn false;\n\t}\n\thomeLoc = null;\n\tcList = [];\n\tpList = [];\n\tvertices = [];\n\tvertices2 = [];\n\tdata.forEach(function(d, tindex) {\n\t\t//if(tindex > 10){\n\t\t//    return false;\n\t\t//}\n\t\t$(this).delay(500);\n\t\tconsole.log(\"delay\");\n\t\tif(d.movestate == 1) {\n\t\t\t//画线\n\t\t\tvar coordinates = d.records;\n\t\t\tvar path = [];\n\t\t\tvar preX = null;\n\t\t\tvar preY = null;\n\t\t\tvar startIndex = null;\n\t\t\tvar endIndex = null;\n\t\t\tcoordinates.forEach(function(p, i) {\n\t\t\t\tvar lat = p[1];\n\t\t\t\tvar lng = p[0];\n\t\t\t\tvar time = p[2];\n\t\t\t\t//console.log(new Date(time));\n\t\t\t\tif(start && end && (time < start || time > end)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tif(startIndex != null) {\n\t\t\t\t\tendIndex = i;\n\t\t\t\t} else {\n\t\t\t\t\tstartIndex = i;\n\t\t\t\t}\n\t\t\t\t//画路径\n\t\t\t\tpath.push(L.latLng(lat, lng));\n\t\t\t\t//\n\t\t\t\t//vertices.push(L.latLng(lat, lng));\n\t\t\t});\n\n\t\t\tif(startIndex != null && startIndex > 0) {\n\t\t\t\tvar p1 = coordinates[startIndex - 1];\n\t\t\t\tvar p2 = coordinates[startIndex];\n\t\t\t\tvar lng1 = p1[0];\n\t\t\t\tvar lng2 = p2[0];\n\t\t\t\tvar lat1 = p1[1];\n\t\t\t\tvar lat2 = p2[1];\n\t\t\t\tvar time1 = p1[2];\n\t\t\t\tvar time2 = p2[2];\n\t\t\t\tvar scale = d3.scale.linear().range([lat1, lat2]).domain([time1, time2]);\n\t\t\t\tvar lat = scale(start);\n\t\t\t\tscale = d3.scale.linear().range([lng1, lng2]).domain([time1, time2]);\n\t\t\t\tvar lng = scale(start);\n\t\t\t\tpath.unshift(L.latLng(lat, lng));\n\t\t\t\tvertices.push(L.latLng(lat, lng));\n\t\t\t}\n\t\t\tif(endIndex != null && endIndex < coordinates.length - 1) {\n\t\t\t\tvar p1 = coordinates[endIndex];\n\t\t\t\tvar p2 = coordinates[endIndex + 1];\n\t\t\t\tvar lng1 = p1[0];\n\t\t\t\tvar lng2 = p2[0];\n\t\t\t\tvar lat1 = p1[1];\n\t\t\t\tvar lat2 = p2[1];\n\t\t\t\tvar time1 = p1[2];\n\t\t\t\tvar time2 = p2[2];\n\t\t\t\tvar scale = d3.scale.linear().range([lat1, lat2]).domain([time1, time2]);\n\t\t\t\tvar lat = scale(end);\n\t\t\t\tscale = d3.scale.linear().range([lng1, lng2]).domain([time1, time2]);\n\t\t\t\tvar lng = scale(end);\n\t\t\t\t//移动的线集\n\t\t\t\tvertices.push(L.latLng(lat, lng));\n\t\t\t}\n\t\t\tpList.push(path);\n\t\t} else {\n\t\t\t//画点\n\t\t\tvar coordinates = d.records;\n\t\t\tvar temp = [];\n\t\t\tcoordinates.forEach(function(p, i) {\n\t\t\t\tvar lat = p[1];\n\t\t\t\tvar lng = p[0];\n\t\t\t\tvar time = p[2];\n\t\t\t\tif(start && end && (time < start || time > end)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tcList.push({\n\t\t\t\t\tlat: lat,\n\t\t\t\t\tlng: lng\n\t\t\t\t});\n\t\t\t\ttemp.push(L.latLng(lat, lng));\n\t\t\t});\n\t\t\t//停留的点集\n\t\t\tvertices2.push(temp);\n\t\t}\n\t});\n\n\thomeLoc = [data[0].HomeLocY, data[0].HomeLocX];\n\n\tthat.updateSvg();\n\n};\n\nprototype.drawMoveProjectory = function() {\n\n\tvar zoom = map.getZoom();\n\tvar that = this;\n\n\tpList.forEach(function(path) {\n\n\t\tcList1 = [];\n\n\t\tif(path.length != 0) {\n\n\t\t\tpath.forEach(function(p) {\n\t\t\t\tvar point = map.latLngToContainerPoint(p);\n\n\t\t\t\tcList1.push({\n\t\t\t\t\tx: point.x,\n\t\t\t\t\ty: point.y\n\t\t\t\t});\n\n\t\t\t});\n\n\t\t\t//\t\t\tvar q = Math.sqrt(zoom) * zoom * 0.5;\n\t\t\t//\t\t\tvar firstPoint = cList1[0];\n\t\t\t//\t\t\tvar lastPoint = cList1[cList1.length - 1];\n\t\t\t//\t\t\tvar k = Math.atan((lastPoint.y - firstPoint.y) / (lastPoint.x - firstPoint.x));\n\t\t\t//\t\t\tvar offsetX = q * Math.sin(k);\n\t\t\t//\t\t\tvar offsetY = -q * Math.cos(k);\n\n\t\t\tcList1.forEach(function(c1, cIndex) {\n\n\t\t\t\tsetTimeout(function() {\n\n\t\t\t\t\t//\t\t\t\t\tif(cIndex == 0) {\n\t\t\t\t\t//\t\t\t\t\t\tconsole.log(\"q:\" + q);\n\t\t\t\t\t//\t\t\t\t\t\tconsole.log(\"firstPoint:\" + firstPoint);\n\t\t\t\t\t//\t\t\t\t\t\tconsole.log(\"lastPoint:\" + lastPoint);\n\t\t\t\t\t//\t\t\t\t\t\tconsole.log(\"k:\" + k);\n\t\t\t\t\t//\t\t\t\t\t\tconsole.log(\"offsetY:\" + offsetY);\n\t\t\t\t\t//\t\t\t\t\t\tconsole.log(\"offsetX:\" + offsetX);\n\t\t\t\t\t//\t\t\t\t\t}\n\t\t\t\t\t//delete pre and add new circle\n\t\t\t\t\t//\t\t\t\t\tthat.drawCircle1(c1, cIndex, cList1.length, offsetX, offsetY);\n\t\t\t\t\tthat.drawCircle1(c1, cIndex, cList1.length);\n\t\t\t\t}, (cIndex * 3000));\n\n\t\t\t})\n\n\t\t}\n\n\t})\n\n};\n\nprototype.getPTrac = function() {\n\treturn pTrac;\n};\n\nprototype.clearTrajectory = function() {\n\tresetSvg();\n};\n\nvar resetSvg = function() {\n\td3.selectAll(\"#mapSvg .primitives\").selectAll(\"*\").remove();\n\td3.selectAll(\"#mapSvg .hull\").selectAll(\"*\").remove();\n\tcList = [];\n\tpList = [];\n\tvertices = [];\n\tvertices2 = [];\n};\n\nprototype.updateSvg = function() {\n\t//delete all cicle\n\td3.selectAll(\"#mapSvg .primitives\").selectAll(\"*\").remove();\n\t//delete all hull\n\td3.selectAll(\"#mapSvg .hull\").selectAll(\"*\").remove();\n\tvar that = this;\n\tthat.drawHulls();\n\n\t//redraw path\n\tpList.forEach(function(p, i) {\n\t\tthat.drawPath(p)\n\t});\n\t//redraw cicle\n\tcList.forEach(function(c) {\n\t\tthat.drawCircle(c)\n\t});\n\n\t//redraw homes\n\tthis.drawHome();\n\tthis.drawHomes();\n};\n\nprototype.drawHome = function() {\n\tif(!homeLoc) {\n\t\treturn false;\n\t}\n\t//lat loc to map canvas\n\tvar coor = converCoor(homeLoc);\n\td3.selectAll(\".homeLoc\").remove();\n\tvar canvas = d3.select(mapSvgDom).select(\".primitives\");\n\tcanvas.append(\"svg:image\")\n\t\t.attr(\"xlink:href\", \"./static/images/home.png\")\n\t\t.attr(\"class\", \"homeLoc\")\n\t\t.attr(\"width\", 10)\n\t\t.attr(\"height\", 10)\n\t\t.attr(\"transform\", function() {\n\t\t\treturn \"translate(\" + (coor.x - 5) + \",\" + (coor.y - 5) + \")\";\n\t\t})\n\t\t.append(\"title\")\n\t\t.text(\"home\");\n};\n\nprototype.drawHomes = function() {\n\tif(!homeLocs) {\n\t\treturn false;\n\t}\n\td3.selectAll(\".homeLoc\").remove();\n\tvar canvas = d3.select(mapSvgDom).select(\".primitives\");\n\thomeLocs.forEach(function(d) {\n\t\tvar coor = converCoor(d);\n\t\tcanvas.append(\"svg:image\")\n\t\t\t.attr(\"xlink:href\", \"./static/images/home.png\")\n\t\t\t.attr(\"class\", \"homeLoc\")\n\t\t\t.attr(\"width\", 10)\n\t\t\t.attr(\"height\", 10)\n\t\t\t.attr(\"transform\", function() {\n\t\t\t\treturn \"translate(\" + (coor.x - 5) + \",\" + (coor.y - 5) + \")\";\n\t\t\t})\n\t\t\t.append(\"title\")\n\t\t\t.text(\"home\");\n\t});\n};\n\n//画单个人的外面包围线\nprototype.drawHulls2 = function() {\n\tvar getAlpha = function(zoom) {\n\t\treturn zoom * zoom * 10;\n\t};\n\tvar zoom = map.getZoom();\n\tvar alpha = getAlpha(zoom);\n\tvar temp = [];\n\tfor(var i = 0; i < vertices.length; i++) {\n\t\tvar coor = converCoor(vertices[i]);\n\t\t//canvas x and y\n\t\ttemp.push([coor.x, coor.y]);\n\t}\n\tvar offset = function(a, dx, dy) {\n\t\t\treturn a.map(function(d) {\n\t\t\t\treturn [d[0] + dx, d[1] + dy];\n\t\t\t});\n\t\t},\n\n\t\tdsq = function(a, b) {\n\t\t\tvar dx = a[0] - b[0],\n\t\t\t\tdy = a[1] - b[1];\n\t\t\treturn dx * dx + dy * dy;\n\t\t},\n\n\t\tasq = alpha * alpha,\n\n\t\t//网状条\n\t\tmesh = d3.geom.delaunay(offset(temp, 0, 0)).filter(function(t) {\n\t\t\treturn dsq(t[0], t[1]) < asq && dsq(t[0], t[2]) < asq && dsq(t[1], t[2]) < asq;\n\t\t});\n\n\tvar canvas = d3.select(mapSvgDom).select(\".hull\");\n\tcanvas.selectAll(\".alphaHull\")\n\t\t.data(mesh)\n\t\t.enter().append(\"path\")\n\t\t.attr(\"class\", \"alphaHull\")\n\t\t.attr(\"d\", function(d) {\n\t\t\treturn \"M\" + d.join(\"L\") + \"Z\";\n\t\t});\n\t//hull.datum(d3.geom.hull(temp)).attr(\"d\", function(d) { return \"M\" + d.join(\"L\") + \"Z\"; });\n\t//this.drawHulls2();\n};\n\n//画画全部的外面的包围线，在整条路径的每个点的经纬度增加随机单位大小的距离\nprototype.drawHulls = function() {\n\tvar temp = [];\n\tfor(var i = 0; i < vertices.length; i++) {\n\t\tvar coor = converCoor(vertices[i]);\n\t\ttemp.push([coor.x + 1 * Math.random(), coor.y + 1 * Math.random()]);\n\t\ttemp.push([coor.x + 1 * Math.random(), coor.y + 1 * Math.random()]);\n\t}\n\tif(temp.length > 2) {\n\t\tvar canvas = d3.select(mapSvgDom).select(\"g.hull\");\n\t\tvar hull = canvas.append(\"path\")\n\t\t\t.attr(\"class\", \"hull\");\n\t\thull.datum(d3.geom.hull(temp)).attr(\"d\", function(d) {\n\t\t\t//d.push(d[0]);\n\t\t\t//var lineFunction = d3.svg.line()\n\t\t\t//    .x(function(d) { return d[0]; })\n\t\t\t//    .y(function(d) { return d[1]; })\n\t\t\t//    .interpolate(\"basic\");\n\t\t\t//return lineFunction(d);\n\t\t\treturn \"M\" + d.join(\"L\") + \"Z\";\n\t\t});\n\t}\n\n\t//\t需要画点的人物轨迹\n\tvertices2.forEach(function(group) {\n\t\tvar temp = [];\n\t\tfor(var i = 0; i < group.length; i++) {\n\t\t\tvar coor = converCoor(group[i]);\n\t\t\tif(i == 0) {\n\t\t\t\ttemp.push([coor.x + 1 * Math.random(), coor.y + 1 * Math.random()]);\n\t\t\t\ttemp.push([coor.x - 1 * Math.random(), coor.y - 1 * Math.random()]);\n\t\t\t}\n\t\t\ttemp.push([coor.x + 1 * Math.random(), coor.y + 1 * Math.random()]);\n\t\t}\n\t\tif(temp.length == 0) {\n\t\t\treturn false;\n\t\t}\n\t\tvar canvas = d3.select(mapSvgDom).select(\"g.hull\");\n\t\tvar hull = canvas.append(\"path\")\n\t\t\t.attr(\"class\", \"hull2\");\n\t\thull.datum(d3.geom.hull(temp)).attr(\"d\", function(d) {\n\t\t\t//d.push(d[0]);\n\t\t\t//var lineFunction = d3.svg.line()\n\t\t\t//    .x(function(d) { return d[0]; })\n\t\t\t//    .y(function(d) { return d[1]; })\n\t\t\t//    .interpolate(\"basic\");\n\t\t\t//return lineFunction(d);\n\t\t\treturn \"M\" + d.join(\"L\") + \"Z\";\n\t\t});\n\t});\n};\n\nprototype.drawCircle1 = function(c1, cIndex, length) {\n\t//prototype.drawCircle1 = function(c1, cIndex, length, offsetX, offsetY) {\n\tvar p = c1;\n\tvar zoom = map.getZoom();\n\tvar canvas = d3.select(mapSvgDom).select(\".primitives\");\n\n\tvar colors = [\"green\", \"blue\", \"#EE00EE\"];\n\tvar color;\n\t//start\n\tif(cIndex == 0) {\n\t\tcolor = colors[0];\n\t} else if(cIndex == length - 1) {\n\t\t//end\n\t\tcolor = colors[2];\n\t} else {\n\t\t//midlle\n\t\tcolor = colors[1];\n\t}\n\n\t//destroy pre circle\t\n\td3.select(mapSvgDom).select(\".primitives .primitive-move\").remove();\n\n\t//\tpoint = (p.x + offsetX) + \",\" + (p.y + offsetY) + \" \" + (p.x - offsetX) + \",\" + (p.y - offsetY) + \" \" + (p.x - offsetY) + \",\" + (p.y - offsetX);\n\n\t//\tconsole.log(\"point:\" + point);\n\n\t//\tif(point.length <= 0) {\n\t//\t\tconsole.error(\"point is null\");\n\t//\t\treturn;\n\t//\t}\n\t//\tcanvas.append('polygon')\n\t//\t\t.attr({\n\t//\t\t\tpoints: point\n\t//\t\t})\n\t//\t\t.attr(\"class\", \"primitive-move\")\n\t//\t\t.style(\"pointer-events\", \"visiblePainted\")\n\t//\t\t.attr(\"fill\", color);\n\n\tcanvas.append(\"circle\")\n\t\t.attr(\"class\", \"primitive-move\")\n\t\t.style(\"pointer-events\", \"visiblePainted\")\n\t\t.attr(\"r\", Math.sqrt(zoom) * (zoom) * 0.1)\n\t\t.attr(\"fill\", color)\n\t\t.attr(\"transform\", function() {\n\t\t\tconsole.log(\"p.x:\" + p.x + \"\\tp.y:\" + p.y);\n\t\t\treturn \"translate(\" + p.x + \",\" + p.y + \")\";\n\t\t});\n\n};\n\n//画点\nprototype.drawCircle = function(circle) {\n\t//\tconsole.log(\"drawCircle\");\n\tvar p = map.latLngToContainerPoint([circle.lat, circle.lng]);\n\tvar zoom = map.getZoom();\n\tvar canvas = d3.select(mapSvgDom).select(\".primitives\");\n\tcanvas.append(\"circle\")\n\t\t.attr(\"class\", \"primitive\")\n\t\t.style(\"pointer-events\", \"visiblePainted\")\n\t\t.attr(\"r\", Math.sqrt(zoom) * zoom * 0.1)\n\t\t.attr(\"fill\", \"#FF5D15\")\n\t\t//.attr(\"stroke-width\", 1)\n\t\t//.attr(\"stroke\", \"white\")\n\t\t//.attr(\"fill-opacity\", 0.6)\n\t\t.attr(\"transform\", function() {\n\t\t\treturn \"translate(\" + p.x + \",\" + p.y + \")\";\n\t\t});\n};\n\n//画路径\nprototype.drawPath = function(path) {\n\tif(path.length == 0) {\n\t\treturn false;\n\t}\n\tvar canvas = d3.select(mapSvgDom).select(\".primitives\");\n\t//lat to container\n\tvar sp = map.latLngToContainerPoint(path[0]);\n\tvar dd = 'M ' + sp.x + ' ' + sp.y;\n\tvar points = [];\n\tpath.forEach(function(p) {\n\t\tvar point = map.latLngToContainerPoint(p);\n\t\tdd += \"L \" + point.x + ' ' + point.y;\n\t\tpoints.push([point.x, point.y]);\n\t});\n\tvar lineFunction = d3.svg.line()\n\t\t.x(function(d) {\n\t\t\treturn d[0];\n\t\t})\n\t\t.y(function(d) {\n\t\t\treturn d[1];\n\t\t})\n\t\t.interpolate(\"cardinal\");\n\t//draw a line of points on path \n\tcanvas.append(\"path\")\n\t\t.attr(\"class\", \"primitive\")\n\t\t.style(\"pointer-events\", \"visiblePainted\")\n\t\t.attr(\"fill\", \"none\")\n\t\t.attr(\"opacity\", 1)\n\t\t.attr(\"d\", function() {\n\t\t\treturn lineFunction(points);\n\t\t})\n\t\t.attr(\"stroke-width\", 2)\n\t\t.attr(\"stroke\", \"#EAFF15\");\n\n\t//var zoom = map.getZoom();\n\t//if(zoom > 12){\n\t//    path.forEach(function(p){\n\t//        var point = map.latLngToContainerPoint(p);\n\t//        canvas.append(\"circle\")\n\t//            .attr(\"class\", \"primitive\")\n\t//            .style(\"pointer-events\", \"visiblePainted\")\n\t//            .attr(\"r\", 2)\n\t//            .attr(\"fill\", \"#FF7300\")\n\t//            //.attr(\"stroke-width\", 1)\n\t//            //.attr(\"stroke\", \"white\")\n\t//            //.attr(\"fill-opacity\", 0.6)\n\t//            .attr(\"transform\", function(){\n\t//                return \"translate(\" + point.x + \",\" + point.y + \")\";\n\t//            });\n\t//    });\n\t//}\n};\n\nprototype.getBrushMode = function() {\n\treturn brushMode;\n};\n\nprototype.clearBrush = function() {\n\tbrushMode = false;\n\thomeLocs = null;\n\tmap.dragging.enable();\n\t$(\"#leaflet-brush\").removeClass(\"clicked\");\n\tboundRect && map.removeLayer(boundRect);\n\tboundRect = null;\n};\n\nprototype.setHomeLocs = function(locs) {\n\thomeLocs = locs;\n};\n\nvar resetBrush = function() {\n\t$(\".track\").remove();\n};\n\nvar converCoor = function(latlng) {\n\treturn map.latLngToContainerPoint(latlng);\n};\n\nmodule.exports = leafletmap;\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./static/js/src/index/leafletmap.js\n ** module id = 2\n ** module chunks = 1\n **/","var util = require(\"util\");\r\nvar nodeData = require(\"nodesProducer\");\r\nvar matrixes = require(\"linksProducer\");\r\nvar coordinates = require(\"coordinates\");\r\nvar clusters = nodeData.clusters;\r\nvar columns = [];\r\nvar timePoints = 84;\r\nvar clustersNum = 20;\r\nvar barPadding = 5;\r\nvar groupPadding = 40;\r\nvar barWidth = 10;\r\nvar padding = 80;\r\n\r\nvar threshold = 0.3;\r\nvar thresholdMin = 0.4;\r\nvar thresholdMax = 0.6;\r\nvar tranformMax = 0;\r\nvar svgPadding = [20, 10];\r\n\r\nvar ySum = [];\r\nvar startDate = new Date(\"2014-01-21 00:00:00\");\r\nvar endDate = new Date(\"2014-01-28 00:00:00\");\r\nvar timeGap = 1000 * 60 * 60 * 2;\r\nvar container;\r\n\r\nvar multiChooseMode = false;\r\nvar selectedNode = {};\r\n\r\nvar sankey = function(dom) {\r\n\tcontainer = dom;\r\n\tthis.render();\r\n};\r\n\r\nvar getPeopleHomeResults;\r\nvar getPeopleHomeIndex;\r\n\r\nvar globalColors = [];\r\nvar flowColors = [\"#dddddd\", \"#bbbbbb\", \"#999999\"];\r\n//var stateColors = [\"#2ca25f\", \"#99d8c9\", \"#e5f5f9\"];\r\nvar stateColors = [\"#75DAB3\", \"#99d8c9\", \"#e5f5f9\"];\r\nvar stateVals = [0.1, 0.9];\r\n\r\nvar prototype = sankey.prototype;\r\n\r\nprototype.render = function() {\r\n\tvar that = this;\r\n\tvar width = barWidth * timePoints + padding * (timePoints - 1) + 40;\r\n\tvar containerWidth = $(container).width();\r\n\tvar svg = $(container).find(\"svg\");\r\n\tif (width > containerWidth) {\r\n\t\tsvg.width(width);\r\n\t\t$(container).find(\"hr\").width(width);\r\n\t} else {\r\n\t\tsvg.width(containerWidth);\r\n\t\t$(container).find(\"hr\").width(width);\r\n\t\tbarWidth = 3 * (containerWidth / 1082);\r\n\t\tpadding = 10 * (containerWidth / 1082);\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\ttype: \"GET\",\r\n\t\turl: util.urlBase + '/getNodes',\r\n\t\tasync: false,\r\n\t\tsuccess: function(data) {\r\n\t\t\tdata.forEach(function(d) {\r\n\t\t\t\tvar temp = {\r\n\t\t\t\t\tcluster: d.clusterid,\r\n\t\t\t\t\tcol: d.timeindex,\r\n\t\t\t\t\tval: parseFloat(d.peoplecount),\r\n\t\t\t\t\tmove: parseFloat(d.percentage)\r\n\t\t\t\t};\r\n\t\t\t\tif (!columns[d.timeindex]) {\r\n\t\t\t\t\tcolumns[d.timeindex] = [];\r\n\t\t\t\t}\r\n\t\t\t\tcolumns[d.timeindex][d.clusterid] = temp;\r\n\t\t\t});\r\n\t\t},\r\n\t\terror: function(data) {\r\n\t\t\tconsole.log(data);\r\n\t\t}\r\n\t});\r\n\r\n\tcolumns.forEach(function(d, i) {\r\n\t\td.sort(function(a, b) {\r\n\t\t\treturn b.move - a.move;\r\n\t\t});\r\n\t\tthat.drawColumn(d, i);\r\n\t});\r\n\r\n\tvar level2 = [];\r\n\tfor (var i = 0; i < columns.length; i++) {\r\n\t\tvar col = columns[i];\r\n\t\tfor (var j = 0; j < col.length; j++) {\r\n\t\t\tif (col[j].move <= stateVals[1]) {\r\n\t\t\t\tlevel2.push(j);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tvar level3 = [];\r\n\tfor (var i = 0; i < columns.length; i++) {\r\n\t\tvar col = columns[i];\r\n\t\tfor (var j = 0; j < col.length; j++) {\r\n\t\t\tif (col[j].move <= stateVals[0]) {\r\n\t\t\t\tlevel3.push(j);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tvar top1 = [];\r\n\tfor (var i = 0; i < 84; i++) {\r\n\t\ttop1.push(0);\r\n\t}\r\n\tdrawStateStream(top1, level2, 0);\r\n\r\n\tvar top2 = [];\r\n\tfor (var i = 0; i < 84; i++) {\r\n\t\ttop2.push((level2[i] + 1 > 19 ? 19 : level2[i] + 1));\r\n\t}\r\n\tdrawStateStream(top2, level3, 1);\r\n\r\n\tvar top3 = [];\r\n\tfor (var i = 0; i < 84; i++) {\r\n\t\ttop3.push((level3[i] + 1 > 19 ? 19 : level3[i] + 1));\r\n\t}\r\n\tvar bottom3 = [];\r\n\tfor (var i = 0; i < 84; i++) {\r\n\t\tbottom3.push(19);\r\n\t}\r\n\tdrawStateStream(top3, bottom3, 2);\r\n\r\n\tcomputeLinks(matrixes);\r\n\t$(\"#slider-range-max\").slider({\r\n\t\trange: true,\r\n\t\tmin: 0,\r\n\t\tmax: 1000,\r\n\t\tvalues: [thresholdMin * 1000, thresholdMax * 1000],\r\n\t\tslide: function(event, ui) {\r\n\t\t\t//$( \"#amount\" ).val( ui.value );\r\n\t\t\t$(\"#amount_min\").val((ui.values[0] / 1000).toFixed(2));\r\n\t\t\t$(\"#amount_max\").val((ui.values[1] / 1000).toFixed(2));\r\n\t\t},\r\n\t\tstop: function(event, ui) {\r\n\t\t\tthresholdMin = ui.values[0] / 1000;\r\n\t\t\tthresholdMax = ui.values[1] / 1000;\r\n\t\t\tcomputeLinks(matrixes);\r\n\t\t}\r\n\t});\r\n\t$(\"#amount_min\").val(($(\"#slider-range-max\").slider(\"values\", 0) / 1000).toFixed(2));\r\n\t$(\"#amount_max\").val(($(\"#slider-range-max\").slider(\"values\", 1) / 1000).toFixed(2));\r\n\r\n\t$(\".multiChoose\").on(\"click\", function() {\r\n\t\tmultiChooseMode = true;\r\n\t\t$(\"#index-sankey svg\").dblclick();\r\n\t\t$(this).addClass(\"clicked\");\r\n\t\t//hide all transition link\r\n\t\td3.selectAll(\".linkGroup .link\").attr(\"opacity\", 0);\r\n\t});\r\n};\r\n\r\nprototype.drawColumn = function(column, index) {\r\n\tvar that = this;\r\n\tvar svg = $(container).find(\"svg\");\r\n\tvar height = svg.height();\r\n\tvar canvas = d3.select(svg[0])\r\n\t\t.select(\"g.nodeGroup\")\r\n\t\t.attr(\"transform\", \"translate(\" + svgPadding[0] + \", \" + svgPadding[1] + \")\");\r\n\tvar left = index * (barWidth + padding);\r\n\tvar sum = 0;\r\n\tcolumn.forEach(function(d) {\r\n\t\tsum += d.val;\r\n\t});\r\n\tySum.push(sum);\r\n\tvar y = d3.scale.linear().domain([0, sum]).range([5, height - groupPadding * 2 - clustersNum * 6 - (clustersNum - 1) * barPadding - 50]);\r\n\tvar flag1th = true;\r\n\tvar flag2th = true;\r\n\tvar counter = 0;\r\n\tvar colors = d3.scale.category20();\r\n\tglobalColors = [];\r\n\tvar moveColor = d3.scale.linear()\r\n\t\t.domain([1, 0.5, 0])\r\n\t\t.range(stateColors);\r\n\tcolumn.forEach(function(d, i) {\r\n\t\tcanvas.append(\"rect\")\r\n\t\t\t.attr(\"cluster\", d.cluster)\r\n\t\t\t.attr(\"row\", i)\r\n\t\t\t.attr(\"col\", d.col)\r\n\t\t\t.attr(\"size\", d.val)\r\n\t\t\t.attr(\"move\", d.move)\r\n\t\t\t.attr(\"x\", left)\r\n\t\t\t.attr(\"y\", counter)\r\n\t\t\t.attr(\"width\", barWidth)\r\n\t\t\t.attr(\"height\", y(d.val))\r\n\t\t\t.attr(\"stroke\", \"none\")\r\n\t\t\t//.attr(\"stroke-width\", 3)\r\n\t\t\t.attr(\"fill\", function() {\r\n\t\t\t\tglobalColors.push(colors(i));\r\n\t\t\t\t//return moveColor(d.move);\r\n\t\t\t\treturn stateColors[0];\r\n\t\t\t})\r\n\t\t\t.attr(\"opacity\", function() {\r\n\t\t\t\treturn util.opacityScale(d.move);\r\n\t\t\t})\r\n\t\t\t.on(\"click\", function() {\r\n\t\t\t\td3.event.stopPropagation();\r\n\r\n\t\t\t\tif (!multiChooseMode) {\r\n\t\t\t\t\tvar cluster = d3.select(this).attr(\"cluster\");\r\n\t\t\t\t\tvar col = d3.select(this).attr(\"col\");\r\n\t\t\t\t\td3.selectAll(\".nodeGroup rect\").classed(\"selected2th\", false);\r\n\t\t\t\t\td3.select(this).classed(\"selected2th\", true);\r\n\t\t\t\t\tthat.leafletmap.findTrajectory(cluster, col);\r\n\t\t\t\t\tcoordinates(\"#index-pcoordinates\", cluster, col);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvar cluster = d3.select(this).attr(\"cluster\");\r\n\t\t\t\t\tvar col = d3.select(this).attr(\"col\");\r\n\t\t\t\t\tvar key = col + ',' + cluster;\r\n\t\t\t\t\tselectedNode[key] = !selectedNode[key];\r\n\t\t\t\t\td3.select(this).classed(\"selected2th\", selectedNode[key]);\r\n\t\t\t\t\tvar all = [];\r\n\t\t\t\t\tfor (var k in selectedNode) {\r\n\t\t\t\t\t\tif (selectedNode[k]) {\r\n\t\t\t\t\t\t\tall.push(k);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (all.length < 2) {\r\n\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar nodelist = all.join('-');\r\n\t\t\t\t\t//$(\".track\").remove();\r\n\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\ttype: 'GET',\r\n\t\t\t\t\t\turl: util.urlBase + '/getPeopleclu',\r\n\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\tnodelist: nodelist\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tsuccess: function(data) {\r\n\t\t\t\t\t\t\t$(\"#index-sidebar .tips\").hide();\r\n\t\t\t\t\t\t\t$(\"#index-sidebar .result\").show();\r\n\t\t\t\t\t\t\tgetPeopleHomeResults = data;\r\n\t\t\t\t\t\t\tgetPeopleHomeIndex = 1;\r\n\t\t\t\t\t\t\tthat.appendResults();\r\n\t\t\t\t\t\t\t$(\".btn.showMore\").unbind(\"click\");\r\n\t\t\t\t\t\t\t$(\".btn.showMore\").on(\"click\", function() {\r\n\t\t\t\t\t\t\t\tgetPeopleHomeIndex++;\r\n\t\t\t\t\t\t\t\tif (getPeopleHomeResults.length <= getPeopleHomeIndex * 20) {\r\n\t\t\t\t\t\t\t\t\t$(\".btn.showMore\").hide();\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tthat.appendResults();\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\terror: function(data) {\r\n\t\t\t\t\t\t\tconsole.log(data);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.on(\"dblclick\", function() {\r\n\t\t\t\td3.event.stopPropagation();\r\n\t\t\t\tif (!multiChooseMode) {\r\n\t\t\t\t\t//reset\r\n\t\t\t\t\td3.selectAll(\".nodeGroup rect\").attr(\"opacity\", 0.1);\r\n\t\t\t\t\td3.selectAll(\".linkGroup .link\").attr(\"opacity\", 0);\r\n\t\t\t\t\td3.selectAll(\".nodeGroup rect\").attr(\"stroke\", \"white\");\r\n\t\t\t\t\td3.selectAll(\".nodeGroup rect\").classed(\"selected\", false);\r\n\t\t\t\t\tvar cluster = d3.select(this).attr(\"cluster\");\r\n\t\t\t\t\tvar col = d3.select(this).attr(\"col\");\r\n\t\t\t\t\td3.selectAll(\".nodeGroup rect[cluster='\" + cluster + \"']\").attr(\"stroke\", \"black\").attr(\"opacity\", 1);\r\n\t\t\t\t\td3.select(this).attr(\"stroke\", \"red\");\r\n\t\t\t\t\td3.select(this).classed(\"selected\", true);\r\n\t\t\t\t\tfindParent(cluster, col);\r\n\t\t\t\t\tfindChild(cluster, col);\r\n\t\t\t\t\tthat.leafletmap.findTrajectory(cluster, col);\r\n\t\t\t\t\tcoordinates(\"#index-pcoordinates\", cluster, col);\r\n\t\t\t\t\td3.selectAll(\"g.nodeGroup polygon\").remove();\r\n\t\t\t\t\tthat.drawClusterStream(cluster, that);\r\n\t\t\t\t\td3.selectAll(\"g.flowGroup polygon\").attr(\"visibility\", \"visible\");\r\n\t\t\t\t\td3.selectAll(\".pixRectFrame\")\r\n\t\t\t\t\t\t.style(\"fill\", \"none\");\r\n\t\t\t\t\td3.select(\"#RectFrame\" + cluster)\r\n\t\t\t\t\t\t.style(\"fill\", \"#D3D3D3\");\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.append(\"title\").text(\"PatternID: \" + d.cluster + ', People: ' + d.val);\r\n\t\tcounter += y(d.val) + barPadding;\r\n\t\tif (d.move <= stateVals[1] && flag1th) {\r\n\t\t\tcounter += groupPadding;\r\n\t\t\tflag1th = false;\r\n\t\t}\r\n\t\tif (d.move <= stateVals[0] && flag2th) {\r\n\t\t\tcounter += groupPadding;\r\n\t\t\tflag2th = false;\r\n\t\t}\r\n\t});\r\n\tvar time = new Date(startDate.valueOf() + index * timeGap);\r\n\tvar timeStr = util.formatTime(time);\r\n\tvar textG = canvas.append(\"text\")\r\n\t\t.attr(\"text-anchor\", \"middle\")\r\n\t\t.attr(\"transform\", \"translate(\" + (left + barWidth / 2) + \", \" + (height - 30) + \")\");\r\n\ttextG.append(\"tspan\").text(timeStr[\"a\"]).attr('x', 0).attr('dy', 0);\r\n\ttextG.append(\"tspan\").text(timeStr[\"b\"]).attr('x', 0).attr('dy', 20);\r\n};\r\n\r\nprototype.appendResults = function() {\r\n\tvar that = this;\r\n\tvar html = '';\r\n\tvar useridlist = [];\r\n\tif (getPeopleHomeResults.length > getPeopleHomeIndex * 20) {\r\n\t\t$(\".btn.showMore\").show();\r\n\t} else {\r\n\t\t$(\".btn.showMore\").hide();\r\n\t}\r\n\tgetPeopleHomeResults.forEach(function(d, i) {\r\n\t\tif (i >= getPeopleHomeIndex * 20) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\thtml += '<tr class=\"item\"> <td>' + (i + 1) + '</td> <td class=\"userid\">' + d.userid + '</td> <td>[' + d.homelocx.toFixed(2) + ', ' + d.homelocy.toFixed(2) + ']</td> </tr>';\r\n\t\tuseridlist.push(d.userid);\r\n\t});\r\n\tvar useridliststr = useridlist.join('-');\r\n\t$.ajax({\r\n\t\ttype: 'get',\r\n\t\turl: util.urlBase + '/getPeopleByIDs',\r\n\t\tdata: {\r\n\t\t\tuseridlist: useridliststr\r\n\t\t},\r\n\t\tsuccess: function(data2) {\r\n\t\t\tconsole.log(data2);\r\n\t\t\t$(\".track\").remove();\r\n\t\t\tdata2.forEach(function(d) {\r\n\t\t\t\tvar path = JSON.parse(JSON.parse(d.clusters));\r\n\t\t\t\tthat.drawPeoplePath(path, d.userid);\r\n\t\t\t});\r\n\t\t},\r\n\t\terror: function() {},\r\n\t});\r\n\t$(\"#index-sidebar .result table tbody\").html(html);\r\n};\r\n\r\nprototype.highlightCluster = function(cluster) {\r\n\t//reset\r\n\td3.selectAll(\".nodeGroup rect\").attr(\"opacity\", 0.1);\r\n\td3.selectAll(\".linkGroup .link\").attr(\"opacity\", 0);\r\n\td3.selectAll(\".nodeGroup rect\").attr(\"stroke\", \"white\");\r\n\td3.selectAll(\".nodeGroup rect\").classed(\"selected\", false);\r\n\r\n\td3.selectAll(\".nodeGroup rect[cluster='\" + cluster + \"']\").each(function(d) {\r\n\t\td3.select(this).attr(\"stroke\", \"black\").attr(\"opacity\", 1);\r\n\t\tvar cluster = d3.select(this).attr(\"cluster\");\r\n\t\tvar col = d3.select(this).attr(\"col\");\r\n\t\tfindParent(cluster, col);\r\n\t\tfindChild(cluster, col);\r\n\t});\r\n\r\n\td3.select(\"g.nodeGroup polygon\").remove();\r\n\tthis.drawClusterStream(cluster, this);\r\n\r\n\td3.selectAll(\"g.flowGroup polygon\").attr(\"visibility\", \"visible\");\r\n};\r\n\r\nprototype.drawPeoplePath = function(path, userid) {\r\n\tvar that = this;\r\n\td3.selectAll(\".linkGroup .link\").attr(\"opacity\", 0);\r\n\tvar canvas = d3.select(container).select(\"svg\")\r\n\t\t.select(\"g.trackGroup\")\r\n\t\t.attr(\"transform\", \"translate(\" + svgPadding[0] + \", \" + svgPadding[1] + \")\");\r\n\tvar flowGenerator = function(d) {\r\n\t\tvar cx1 = d.sx + 50;\r\n\t\tvar cy1 = d.sy;\r\n\t\tvar cx2 = d.ex - 50;\r\n\t\tvar cy2 = d.ey;\r\n\t\tvar path = [\"M \" + (d.sx) + \" \" + d.sy];\r\n\t\tpath.push(\"C \" + cx1 + ' ' + cy1 + ' ' + cx2 + ' ' + cy2 + ' ' + d.ex + ' ' + d.ey);\r\n\r\n\t\treturn path.join(\" \");\r\n\t};\r\n\tvar hash = {};\r\n\tvar clusterArray = [];\r\n\r\n\tfor (var j = 0; j < path.length; j++) {\r\n\t\tvar index = path[j][0];\r\n\t\tvar cluster = path[j][1];\r\n\t\tif (!hash[cluster]) {\r\n\t\t\tclusterArray.push(cluster);\r\n\t\t\thash[cluster] = true;\r\n\t\t}\r\n\t\tif (!path[j + 1]) {\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tvar temp = {};\r\n\t\tvar cluster_next = path[j + 1][1];\r\n\t\tvar sourceDom = d3.select(\"g.nodeGroup rect[col='\" + index + \"'][cluster='\" + cluster + \"']\");\r\n\t\tvar targetDom = d3.select(\"g.nodeGroup rect[col='\" + (index + 1) + \"'][cluster='\" + cluster_next + \"']\");\r\n\t\tvar sH = parseFloat(sourceDom.attr(\"height\"));\r\n\t\tvar eH = parseFloat(targetDom.attr(\"height\"));\r\n\t\tvar sx = parseFloat(sourceDom.attr(\"x\")) + barWidth;\r\n\t\tvar sy = parseFloat(sourceDom.attr(\"y\")) + sH / 2;\r\n\t\tvar ex = parseFloat(targetDom.attr(\"x\")) - 6;\r\n\t\tvar ey = parseFloat(targetDom.attr(\"y\")) + eH / 2;\r\n\t\ttemp.sx = sx;\r\n\t\ttemp.sy = sy;\r\n\t\ttemp.ex = ex;\r\n\t\ttemp.ey = ey;\r\n\t\tcanvas.append(\"path\")\r\n\t\t\t.attr(\"class\", \"track\")\r\n\t\t\t.attr(\"userid\", userid)\r\n\t\t\t.attr(\"d\", flowGenerator(temp))\r\n\t\t\t.attr(\"fill\", \"none\")\r\n\t\t\t.attr(\"stroke\", util.transitionColor)\r\n\t\t\t.attr(\"stroke-width\", 2)\r\n\t\t\t.attr(\"opacity\", 1)\r\n\t\t\t.attr(\"marker-end\", 'url(#arrow)')\r\n\t\t\t.attr(\"pointer-events\", 'none')\r\n\t\t\t.on(\"click\", function(d) {\r\n\t\t\t\t//console.log(d);\r\n\t\t\t});\r\n\t}\r\n\r\n\t//clusterArray.forEach(function(d){\r\n\t//    drawClusterStream(d, that);\r\n\t//});\r\n};\r\n\r\nprototype.addBrush = function() {\r\n\tvar that = this;\r\n\tvar width = $(container).find(\"svg\").width();\r\n\tvar height = $(container).find(\"svg\").height();\r\n\tvar points = [];\r\n\tfor (var i = 0; i < 84; i++) {\r\n\t\tvar temp = {\r\n\t\t\tindex: i,\r\n\t\t\ttime: new Date(startDate.valueOf() + i * timeGap)\r\n\t\t};\r\n\t\tpoints.push(temp);\r\n\t}\r\n\tvar timeExtent = d3.extent(points, function(d) {\r\n\t\treturn new Date(d.time);\r\n\t});\r\n\tvar x = d3.time.scale()\r\n\t\t.range([0, width])\r\n\t\t.domain(timeExtent);\r\n\tvar brush = d3.svg.brush()\r\n\t\t.x(x)\r\n\t\t.on('brushend', brushend);\r\n\td3.select(\"g.nodeGroup\")\r\n\t\t.append('g')\r\n\t\t.attr('class', 'x brush')\r\n\t\t.call(brush).selectAll('rect')\r\n\t\t.attr('y', -6)\r\n\t\t.attr('height', height);\r\n\r\n\tfunction brushend() {\r\n\t\tvar l = brush.extent()[0];\r\n\t\tvar r = brush.extent()[1];\r\n\t\tif (brush.empty()) {\r\n\r\n\t\t} else {\r\n\t\t\tvar startDate = new Date(l);\r\n\t\t\tvar start = startDate.valueOf();\r\n\t\t\tvar endDate = new Date(r);\r\n\t\t\tvar end = endDate.valueOf();\r\n\t\t\tvar pTrac = that.leafletmap.getPTrac();\r\n\t\t\tthat.leafletmap.drawPTrajectory(pTrac, start, end);\r\n\t\t\tpTrac && coordinates(\"#index-pcoordinates\", 0, 0, pTrac[0].userid, start, end);\r\n\t\t}\r\n\t}\r\n};\r\n\r\nprototype.clearBrush = function() {\r\n\t$(\".nodeGroup g.brush\").remove();\r\n};\r\n\r\nvar findParent = function(cluster, col) {\r\n\tvar key = col + '-' + cluster;\r\n\tvar links = d3.selectAll(\".link[target='\" + key + \"']\");\r\n\tif (links[0].length == 0) {\r\n\t\treturn false;\r\n\t} else {\r\n\t\tlinks.each(function() {\r\n\t\t\td3.select(this).attr(\"opacity\", 0.8);\r\n\t\t\tvar source = d3.select(this).attr(\"source\");\r\n\t\t\tvar col1 = source.split(\"-\")[0];\r\n\t\t\tvar cluster1 = source.split(\"-\")[1];\r\n\t\t\td3.select(\"rect[cluster='\" + cluster1 + \"'][col='\" + col1 + \"']\").attr(\"stroke\", \"black\").attr(\"opacity\", 1);\r\n\t\t\tfindParent(cluster1, col1);\r\n\t\t});\r\n\t}\r\n};\r\n\r\nvar findChild = function(cluster, col) {\r\n\tvar key = col + '-' + cluster;\r\n\tvar links = d3.selectAll(\".link[source='\" + key + \"']\");\r\n\tif (links[0].length == 0) {\r\n\t\treturn false;\r\n\t} else {\r\n\t\tlinks.each(function() {\r\n\t\t\td3.select(this).attr(\"opacity\", 0.8);\r\n\t\t\tvar target = d3.select(this).attr(\"target\");\r\n\t\t\tvar col1 = target.split(\"-\")[0];\r\n\t\t\tvar cluster1 = target.split(\"-\")[1];\r\n\t\t\td3.select(\"rect[cluster='\" + cluster1 + \"'][col='\" + col1 + \"']\").attr(\"stroke\", \"black\").attr(\"opacity\", 1);\r\n\t\t\tfindChild(cluster1, col1);\r\n\t\t});\r\n\t}\r\n};\r\n\r\nvar computeLinks = function(matrixes) {\r\n\tvar svg = $(container).find(\"svg\");\r\n\tvar height = svg.height();\r\n\r\n\tfunction getScale(timeIndex) {\r\n\t\treturn d3.scale.linear().domain([0, ySum[timeIndex]]).range([10, height - groupPadding * 2 - (clustersNum - 1) * barPadding - 50]);\r\n\t}\r\n\tvar links = [];\r\n\tmatrixes.forEach(function(matrix, index) {\r\n\t\tif (index == 0) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tfor (var i = 0; i < matrix.length; i++) {\r\n\t\t\tvar cluster = matrix[i];\r\n\t\t\tfor (var j = 0; j < cluster.length; j++) {\r\n\t\t\t\tvar n1 = d3.select(\".nodeGroup rect[col='\" + (index - 1) + \"'][cluster='\" + j + \"']\");\r\n\t\t\t\tvar n2 = d3.select(\".nodeGroup rect[col='\" + (index) + \"'][cluster='\" + i + \"']\");\r\n\t\t\t\t//var size = parseFloat(n1.attr(\"size\"));\r\n\t\t\t\t//var val = size * matrix[i][j];\r\n\t\t\t\t//if(val > tranformMax){\r\n\t\t\t\t//    tranformMax = val;\r\n\t\t\t\t//}\r\n\t\t\t\tif (matrix[i][j] > thresholdMin && matrix[i][j] < thresholdMax && i != j) {\r\n\t\t\t\t\t//drawLink(i, j, index, matrix[i][j]);\r\n\t\t\t\t\tvar link = {\r\n\t\t\t\t\t\tsource: {\r\n\t\t\t\t\t\t\tdom: n1,\r\n\t\t\t\t\t\t\tcol: index - 1,\r\n\t\t\t\t\t\t\tcluster: j\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\ttarget: {\r\n\t\t\t\t\t\t\tdom: n2,\r\n\t\t\t\t\t\t\tcol: index,\r\n\t\t\t\t\t\t\tcluster: i\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tvalue: matrix[i][j]\r\n\t\t\t\t\t};\r\n\t\t\t\t\tlinks.push(link);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\tvar incomes = {};\r\n\tvar outcomes = {};\r\n\tvar linksToDraw = [];\r\n\tlinks.forEach(function(link) {\r\n\t\tvar temp = {\r\n\t\t\tsx: null,\r\n\t\t\tsy: null,\r\n\t\t\tsy0: null,\r\n\t\t\tsy1: null,\r\n\t\t\tex: null,\r\n\t\t\tey: null,\r\n\t\t\tey0: null,\r\n\t\t\tey1: null,\r\n\t\t\tsource: null,\r\n\t\t\ttarget: null,\r\n\t\t\tval: null\r\n\t\t\t\t//size: null\r\n\t\t};\r\n\t\ttemp.val = link.value;\r\n\r\n\t\tvar source = link.source;\r\n\t\tvar target = link.target;\r\n\t\tvar sourceDom = source.dom;\r\n\t\tvar sourceSize = parseFloat(sourceDom.attr(\"size\"));\r\n\t\tvar targetDom = target.dom;\r\n\t\tvar scol = sourceDom.attr(\"col\");\r\n\t\tvar ecol = targetDom.attr(\"col\");\r\n\t\tvar sH = parseFloat(sourceDom.attr(\"height\"));\r\n\t\tvar eH = parseFloat(targetDom.attr(\"height\"));\r\n\t\ttemp.sx = parseFloat(sourceDom.attr(\"x\")) + barWidth;\r\n\t\ttemp.ex = parseFloat(targetDom.attr(\"x\")) - 6;\r\n\t\tvar stransform = getScale(scol)(link.value * sourceSize);\r\n\t\tvar etransform = getScale(ecol)(link.value * sourceSize);\r\n\r\n\t\tvar key = source.col + '-' + source.cluster;\r\n\t\ttemp.source = key;\r\n\t\ttemp.sy0 = parseFloat(sourceDom.attr(\"y\"));\r\n\t\ttemp.sy1 = temp.sy0 + sH;\r\n\t\ttemp.sy = (temp.sy0 + temp.sy1) / 2;\r\n\t\t//if(!outcomes[key]){\r\n\t\t//    temp.sy0 = parseFloat(sourceDom.attr(\"y\")) + 3;\r\n\t\t//    temp.sy1 = temp.sy0 + stransform;\r\n\t\t//    outcomes[key] = stransform + 3;\r\n\t\t//}else{\r\n\t\t//    temp.sy0 = parseFloat(sourceDom.attr(\"y\")) + outcomes[key];\r\n\t\t//    temp.sy1 = temp.sy0 + stransform;\r\n\t\t//    outcomes[key] += stransform\r\n\t\t//}\r\n\r\n\t\tvar key2 = target.col + '-' + target.cluster;\r\n\t\ttemp.target = key2;\r\n\t\ttemp.ey0 = parseFloat(targetDom.attr(\"y\"));\r\n\t\ttemp.ey1 = temp.ey0 + eH;\r\n\t\ttemp.ey = (temp.ey0 + temp.ey1) / 2;\r\n\t\t//if(!incomes[key2]){\r\n\t\t//    temp.ey0 = parseFloat(targetDom.attr(\"y\")) + 3;\r\n\t\t//    temp.ey1 = temp.ey0 + etransform;\r\n\t\t//    incomes[key2] = etransform + 3;\r\n\t\t//}else{\r\n\t\t//    temp.ey0 = parseFloat(targetDom.attr(\"y\")) + incomes[key2];\r\n\t\t//    temp.ey1 = temp.ey0 + etransform;\r\n\t\t//    incomes[key2] += etransform;\r\n\t\t//}\r\n\t\tlinksToDraw.push(temp);\r\n\t});\r\n\tdrawLinks(linksToDraw);\r\n};\r\n\r\nvar drawLinks = function(links) {\r\n\td3.selectAll(\".linkGroup\").remove();\r\n\tvar flowGenerator = function(d) {\r\n\t\t//sankey flow\r\n\t\t//var path = [\"M \" + (d.sx) + \",\" + d.sy0];\r\n\t\t//var cpx = padding / 2;\r\n\t\t//path.push(\"C \" + (d.sx + cpx) + \",\" + d.sy0 +\r\n\t\t//    \" \" + (d.ex - cpx) + \",\" + d.ey0 +\r\n\t\t//    \" \" + (d.ex) + \",\" + d.ey0);\r\n\t\t//path.push(\"L \" + (d.ex) + \",\" + d.ey0 +\r\n\t\t//    \" \" + (d.ex) + \",\" + d.ey1);\r\n\t\t//path.push(\"C \" + (d.ex- cpx) + \",\" + d.ey1 +\r\n\t\t//    \" \" + (d.sx + cpx) + \",\" + d.sy1 +\r\n\t\t//    \" \" + (d.sx) + \",\" + d.sy1);\r\n\t\t//\r\n\t\t//path.push(\"L \" + d.sx + \",\" + d.sy1+\r\n\t\t//    \" \" + d.sx + \",\" + d.sy0);\r\n\t\t//return path.join(\" \");\r\n\r\n\t\t//bezier curve\r\n\t\tvar cx1 = d.sx + 50;\r\n\t\tvar cy1 = d.sy;\r\n\t\tvar cx2 = d.ex - 50;\r\n\t\tvar cy2 = d.ey;\r\n\t\tvar path = [\"M \" + (d.sx) + \" \" + d.sy];\r\n\t\tpath.push(\"C \" + cx1 + ' ' + cy1 + ' ' + cx2 + ' ' + cy2 + ' ' + d.ex + ' ' + d.ey);\r\n\r\n\t\treturn path.join(\" \");\r\n\t};\r\n\r\n\tvar canvas = d3.select(container).select(\"svg\")\r\n\t\t.append(\"g\")\r\n\t\t.attr(\"class\", \"linkGroup\")\r\n\t\t.attr(\"transform\", \"translate(\" + svgPadding[0] + \", \" + svgPadding[1] + \")\");\r\n\t//var colorScale = d3.scale.linear()\r\n\t//    .domain([thresholdMin, thresholdMax])\r\n\t//    .range([\"#f0f0f0\", \"#636363\"]);\r\n\r\n\tvar widthScale = d3.scale.linear()\r\n\t\t.domain([thresholdMin, thresholdMax])\r\n\t\t.range([1, 6]);\r\n\r\n\tvar links = canvas.selectAll(\".link\")\r\n\t\t.data(links)\r\n\t\t.enter()\r\n\t\t.append(\"path\")\r\n\t\t.attr(\"class\", \"link\")\r\n\t\t.attr(\"d\", flowGenerator)\r\n\t\t.attr(\"source\", function(d) {\r\n\t\t\treturn d.source;\r\n\t\t})\r\n\t\t.attr(\"target\", function(d) {\r\n\t\t\treturn d.target;\r\n\t\t})\r\n\t\t.attr(\"fill\", \"none\")\r\n\t\t.attr(\"stroke\", util.transitionColor)\r\n\t\t.attr(\"stroke-width\", function(d) {\r\n\t\t\treturn widthScale(d.val);\r\n\t\t})\r\n\t\t.attr(\"opacity\", 0.8)\r\n\t\t.attr(\"marker-end\", 'url(#arrow)')\r\n\t\t.on(\"click\", function(d) {\r\n\t\t\t//console.log(d);\r\n\t\t});\r\n};\r\n\r\nprototype.drawClusterStream = function(cluterIndex) {\r\n\td3.selectAll(\".clusterStream\").remove();\r\n\tif ($(\"polygon[cluster='\" + cluterIndex + \"']\").length > 0) {\r\n\t\treturn false;\r\n\t}\r\n\tvar vertices = [];\r\n\tvar nodes = [];\r\n\td3.selectAll(\".nodeGroup rect[cluster='\" + cluterIndex + \"']\").each(function(d) {\r\n\t\tnodes.push(d3.select(this));\r\n\t});\r\n\tfor (var i = 0; i < nodes.length; i++) {\r\n\t\tvar node = nodes[i];\r\n\t\tvar x = parseFloat(node.attr(\"x\"));\r\n\t\tvar y = parseFloat(node.attr(\"y\"));\r\n\t\tvar p1 = [x, y - 3];\r\n\t\tvar p2 = [x + barWidth, y - 3];\r\n\t\tvertices.push(p1);\r\n\t\tvertices.push(p2);\r\n\t}\r\n\tfor (var i = nodes.length - 1; i > -1; i--) {\r\n\t\tvar node = nodes[i];\r\n\t\tvar x = parseFloat(node.attr(\"x\"));\r\n\t\tvar y = parseFloat(node.attr(\"y\"));\r\n\t\tvar h = parseFloat(node.attr(\"height\"));\r\n\t\tvar p1 = [x + barWidth, y + h + 3];\r\n\t\tvar p2 = [x, y + h + 3];\r\n\t\tvertices.push(p1);\r\n\t\tvertices.push(p2);\r\n\t}\r\n\tvar stream = d3.select(\"g.nodeGroup\").append('polygon')\r\n\t\t.attr(\"class\", \"clusterStream\")\r\n\t\t.attr(\"cluster\", cluterIndex)\r\n\t\t.style({\r\n\t\t\t//fill: globalColors[cluterIndex],\r\n\t\t\t//fill: \"#FFB000\",\r\n\t\t\tfill: \"grey\",\r\n\t\t\topacity: 0.5\r\n\t\t})\r\n\t\t.attr('points', vertices);\r\n\tif (!this.locked) {\r\n\t\tstream.style(\"pointer-events\", \"none\");\r\n\t} else {\r\n\t\tstream.on(\"mouseover\", function() {\r\n\t\t\tvar cluster = d3.select(this).attr(\"cluster\");\r\n\t\t\td3.select(this).style(\"opacity\", 0.5);\r\n\t\t\td3.selectAll(\".pixRectFrame\")\r\n\t\t\t\t.style(\"fill\", \"none\");\r\n\t\t\td3.select(\"#RectFrame\" + cluster)\r\n\t\t\t\t.style(\"fill\", \"#D3D3D3\");\r\n\t\t}).on(\"mouseleave\", function() {\r\n\t\t\td3.select(this).style(\"opacity\", 0.1);\r\n\t\t\td3.selectAll(\".pixRectFrame\")\r\n\t\t\t\t.style(\"fill\", \"none\");\r\n\t\t});\r\n\t}\r\n\r\n};\r\n\r\nprototype.setMultiChooseMode = function(mode) {\r\n\tmultiChooseMode = mode;\r\n\tselectedNode = {};\r\n};\r\n\r\nvar drawStateStream = function(top, bottom, state) {\r\n\tvar vertices = [];\r\n\ttop.forEach(function(d, i) {\r\n\t\ttry {\r\n\t\t\tvar node = d3.select(\".nodeGroup rect[row='\" + d + \"'][col='\" + i + \"']\");\r\n\t\t\tvar x = parseFloat(node.attr(\"x\"));\r\n\t\t\tvar y = parseFloat(node.attr(\"y\"));\r\n\t\t\tvar p1 = [x, y - 8];\r\n\t\t\tvar p2 = [x + barWidth, y - 8];\r\n\t\t\tvertices.push(p1);\r\n\t\t\tvertices.push(p2);\r\n\t\t} catch (e) {\r\n\t\t\tconsole.log(d, i);\r\n\t\t}\r\n\r\n\t});\r\n\tfor (var i = bottom.length - 1; i > -1; i--) {\r\n\t\tvar node = d3.select(\".nodeGroup rect[row='\" + bottom[i] + \"'][col='\" + i + \"']\");\r\n\t\tvar x = parseFloat(node.attr(\"x\"));\r\n\t\tvar y = parseFloat(node.attr(\"y\"));\r\n\t\tvar h = parseFloat(node.attr(\"height\"));\r\n\t\tvar p1 = [x + barWidth, y + h + 8];\r\n\t\tvar p2 = [x, y + h + 8];\r\n\t\tvertices.push(p1);\r\n\t\tvertices.push(p2);\r\n\t}\r\n\td3.select(\"g.flowGroup\")\r\n\t\t.attr(\"transform\", \"translate(\" + svgPadding[0] + \", \" + svgPadding[1] + \")\")\r\n\t\t.append('polygon')\r\n\t\t.style({\r\n\t\t\tfill: stateColors[state],\r\n\t\t\topacity: 0.2\r\n\t\t})\r\n\t\t.attr('points', vertices)\r\n\t\t.attr(\"visibility\", \"hidden\")\r\n\t\t.style(\"pointer-events\", \"none\");\r\n};\r\n\r\nmodule.exports = sankey;\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./static/js/src/index/sankey.js\n ** module id = 3\n ** module chunks = 1\n **/","/**\r\n * Created by huwanqi on 2016/3/15.\r\n */\r\nvar util = require(\"util\");\r\nvar timePoints = 84;\r\nvar clustersNum;\r\n\r\nvar clusters = [];\r\nvar columns = [];\r\n\r\n$.ajax({\r\n    url: \"/static/data/nodesize.csv\",\r\n    async: false,\r\n    type: 'GET',\r\n    success: function(data){\r\n        clusters = util.CSVToArray(data);\r\n        clustersNum = clusters.length;\r\n        columns = [];\r\n        for(var i = 0; i < timePoints; i++){\r\n            columns[i] = [];\r\n            for(var j = 0; j < clustersNum; j++){\r\n                columns[i].push(parseFloat(clusters[j][i]));\r\n            }\r\n        }\r\n    },\r\n    error: function(data){\r\n        console.log(data);\r\n    }\r\n});\r\n\r\nmodule.exports = {\r\n    clusters: clusters,\r\n    columns: columns,\r\n    timePoints: timePoints,\r\n    clustersNum: clustersNum\r\n};\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./static/js/src/index/nodesProducer.js\n ** module id = 4\n ** module chunks = 1\n **/","/**\r\n * Created by huwanqi on 2016/3/15.\r\n */\r\nvar util = require(\"util\");\r\nvar nodeData = require(\"nodesProducer\");\r\nvar clustersNum = 20;\r\nvar timePoints = 84;\r\n\r\nvar matrixes = [];\r\n\r\n$.ajax({\r\n    url: \"/static/data/transition4.csv\",\r\n    async: false,\r\n    type: 'GET',\r\n    success: function(data){\r\n        var rawData = util.CSVToArray(data);\r\n        for(var i = 0; i < timePoints; i++){\r\n            matrixes[i] = [];\r\n            for(var j = 0; j < rawData.length; j++){\r\n                var row = rawData[j];\r\n                var temp = [];\r\n                for(var k = i * clustersNum; k < (i+1) * clustersNum; k++){\r\n                    temp.push(parseFloat(row[k]));\r\n                }\r\n                matrixes[i].push(temp);\r\n            }\r\n        }\r\n    },\r\n    error: function(data){\r\n        console.log(data);\r\n    }\r\n});\r\n\r\nmodule.exports = matrixes;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./static/js/src/index/linksProducer.js\n ** module id = 5\n ** module chunks = 1\n **/","//热力图\r\nvar util = require(\"util\");\r\n\r\nvar fields = {\r\n\tAveLocX: 6,\r\n\tAveLocY: 7,\r\n\tAveSpeed: 2,\r\n\tETrand: 0,\r\n\tEunc: 1,\r\n\tHomeLocX: 8,\r\n\tHomeLocY: 9,\r\n\tMoveDis: 3,\r\n\tMoveRatio: 5,\r\n\tRg: 4\r\n};\r\n\r\nvar fieldsColor = [\"#a6cee3\", \"#1f78b4\", \"#b2df8a\", \"#33a02c\", \"#fb9a99\", \"#e31a1c\", \"#fdbf6f\", \"#ff7f00\", \"#cab2d6\", \"#6a3d9a\"];\r\n\r\nvar fields2 = [\r\n\t\"AveLocX\",\r\n\t\"AveLocY\",\r\n\t\"AveSpeed\",\r\n\t\"ETrand\",\r\n\t\"Eunc\",\r\n\t\"HomeLocX\",\r\n\t\"HomeLocY\",\r\n\t\"MoveDis\",\r\n\t\"MoveRatio\",\r\n\t\"Rg\"\r\n];\r\n\r\nfunction render(dom, type, time, userid, start, end) {\r\n\tvar coord_width = $(dom).width(),\r\n\t\tcoord_height = $(dom).height();\r\n\r\n\td3.select(dom).select(\"svg\").remove();\r\n\td3.select(dom)\r\n\t\t.append(\"svg\")\r\n\t\t.attr(\"id\", \"coord\")\r\n\t\t.style(\"width\", coord_width + \"px\")\r\n\t\t.style(\"height\", coord_height + \"px\");\r\n\r\n\tvar Bar_margin = {top: coord_height/5, right: coord_width/60, bottom: coord_height/8, left: coord_width/60},\r\n\t\tBar_width = coord_width/10-Bar_margin.right-Bar_margin.left,\r\n\t\tBar_height = coord_height/7*4;\r\n\tvar Bar_len = Bar_margin.left+Bar_margin.right+Bar_width;\r\n\r\n\tvar Bar_x = d3.scale.linear()\r\n\t\t.range([0, Bar_width]);\r\n\tvar Bar_y = d3.scale.linear()\r\n\t\t.range([Bar_height, 0]);\r\n\r\n\tvar Bar_xdomain;\r\n\tvar Bar_ydomain;\r\n\tBar_y.domain([0, 10]);\r\n\r\n\tvar Bar_xAxis = d3.svg.axis()\r\n\t\t.scale(Bar_x)\r\n\t\t.orient(\"bottom\");\r\n\tvar Bar_yAxis = d3.svg.axis()\r\n\t\t.scale(Bar_y)\r\n\t\t// .ticks(10)\r\n\t\t.tickValues(0,0)\r\n\t\t// .tickPadding(0)\r\n\t\t// .tickValues(0,0)\r\n\t\t.orient(\"left\");\r\n\r\n\tvar Bar_name = [['Temporal correlated','Entropy'],['Temporal uncorrelated','Entropy'],\r\n\t\t\t\t\t['Average',' Speed'], ['Activity','  Mileage'],\r\n\t\t\t\t\t['Radius','of Gyration'],['Activity','  Radius'],\r\n\t\t\t\t\t['Centroid','Longtitude'],[' Centroid','Latitude'],\r\n\t\t\t\t\t['  Residence','Longtitude'],[' Residence','Latitude']\r\n\t\t\t\t\t];\r\n\r\n\tvar Coord_num = 10, Bar_num = 10;\r\n\t//var Bar_max = 100;\r\n\tvar Bar_max = [];\r\n\tvar statistics = null;\r\n\tvar path = '/statistics';\r\n\tif (!time && time!=0)\r\n\t{\r\n\t\tif (!type && type!=0) path = '/statisticsTotal';\r\n\t\telse path = '/statisticsWithoutTime';\r\n\t} \r\n\tif (userid || userid == 0) path = '/statisticsTotal';\r\n\t//console.log(path);\r\n\t$.ajax({\r\n\t\ttype: \"GET\",\r\n\t\tasync: false,\r\n\t\turl: util.urlBase + path,\r\n\t\tdata: {\r\n\t\t\ttime: time,\r\n\t\t\ttype: type\r\n\t\t},\r\n\t\tasync: false,\r\n\t\tsuccess: function(data){\r\n\t\t\t// console.log(data);\r\n\t\t\tstatistics = data;\r\n\t\t},\r\n\t\terror: function(data){\r\n\t\t\tconsole.log(data);\r\n\t\t}\r\n\t});\r\n\tvar i = -1;\r\n\tvar Bar_data = [];\r\n\tfor(var i = 0; i < Coord_num; i++) {\r\n\t\tBar_data[i] = [];\r\n\t\tBar_max[i] = 0;\r\n\t\tfor (var j = 0; j < Bar_num; j++){\r\n\t\t\tvar count = statistics[i * Coord_num + j].pointscounts;\r\n\t\t\tif(count > Bar_max[i]){\r\n\t\t\t\tBar_max[i] = count;\r\n\t\t\t}\r\n\t\t\tBar_data[i][j] = count;\r\n\t\t}\r\n\t}\r\n\r\n\tvar fieldRanges = null;\r\n\t$.ajax({\r\n\t\ttype: \"GET\",\r\n\t\turl: util.urlBase + '/getClusterRange',\r\n\t\tasync: false,\r\n\t\tsuccess: function(data){\r\n\t\t\tfieldRanges = data[0];\r\n\t\t},\r\n\t\terror: function(data){\r\n\t\t\tconsole.log(data);\r\n\t\t}\r\n\t});\r\n\r\n\t// 信息标题栏\r\n\tvar coord_text = d3.select(\"#coord\")\r\n\t\t.append(\"g\")\r\n\t\t.attr(\"transform\", \"translate(\" + (Bar_margin.left) + \",\" + Bar_margin.top/2 + \")\");\r\n\r\n\tvar time_text, type_text;\r\n\tif (time || time == 0) time_text = \"Time range: \"+time;\r\n\telse time_text = \"Time range: full\";\r\n\tif (type || type == 0) type_text = \"Mobility pattern: \"+type;\r\n\telse type_text = \"Mobility pattern: all\";\r\n\r\n\tvar vectors_single;\r\n\t// 单个人特征值\r\n\tif (userid || userid == 0) {\r\n\t\ttime_text = \"Time range: full\";\r\n\t\ttype_text = \"Mobility pattern: all\";\r\n\t\tvar Person_vertices = [];\r\n\t\tvar coord_trun = [6,7,2,0,1,8,9,3,5,4];\r\n\t\tif(start && end){\r\n\t\t\t$.ajax({\r\n\t\t\t\ttype: 'GET',\r\n\t\t\t\turl: util.urlBase + '/getFeatureByIdTime',\r\n\t\t\t\tasync: false,\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tid: userid,\r\n\t\t\t\t\tstime: start,\r\n\t\t\t\t\tetime: end\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\tvectors_single = data;\r\n\t\t\t\t},\r\n\t\t\t\terror: function(data){\r\n\t\t\t\t\tconsole.log(data);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}else{\r\n\t\t\t$.ajax({\r\n\t\t\t\ttype: \"GET\",\r\n\t\t\t\turl: util.urlBase + '/getPeopleFeature',\r\n\t\t\t\tasync: false,\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tid: userid\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\ttry{\r\n\t\t\t\t\t\tvectors_single = data[0].featureavg.split(\",\");\r\n\t\t\t\t\t}catch(e){\r\n\t\t\t\t\t\tvectors_single = [0,0,0,0,0,0,0,0,0,0];\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\terror: function(data){\r\n\t\t\t\t\tconsole.log(data);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\ttry{\r\n\t\t\t//vectors_single.forEach(function(d){\r\n\t\t\t//\tvar str = d.featureavg;\r\n\t\t\t//\tfor (var i = 0; i < 9; i++) {\r\n\t\t\t//\t\tvar pos = str.indexOf(\",\");\r\n\t\t\t//\t\tvar j = str.substring(0, pos);\r\n\t\t\t//\t\tstr = str.substring(pos+1, str.length);\r\n\t\t\t//\t\tj = parseInt(j * 10);\r\n\t\t\t//\t\tPerson_vertices[coord_trun[i]] = [Bar_len*coord_trun[i], Bar_y(j) - Bar_height/20];\r\n\t\t\t//\t}\r\n\t\t\t//\tPerson_vertices[coord_trun[i]] = [Bar_len*coord_trun[i], Bar_y(parseInt(str * 10)) - Bar_height/20];\r\n\t\t\t//});\r\n\r\n            if(vectors_single.length !== 0){\r\n                for (var i = 0; i < 10; i++) {\r\n                    var val = vectors_single[i];\r\n                    Person_vertices[coord_trun[i]] = [Bar_len*coord_trun[i], Bar_y(val*10) - Bar_height/20];\r\n                }\r\n\r\n                var line = d3.select(\"#coord\")\r\n                    .append(\"g\")\r\n                    .attr(\"transform\", \"translate(\" + Bar_margin.left + \",\" + Bar_margin.top + \")\");\r\n                for (var i = 1; i < 10; i++)\r\n                {\r\n                    line.append(\"line\")\r\n                        .style({\r\n                            stroke: 'grey',\r\n                            \"stroke-width\": 2,\r\n                            opacity: 0.5\r\n                        })\r\n                        .attr(\"x1\", Person_vertices[i-1][0])\r\n                        .attr(\"y1\", Person_vertices[i-1][1])\r\n                        .attr(\"x2\", Person_vertices[i][0])\r\n                        .attr(\"y2\", Person_vertices[i][1]);\r\n                }\r\n            }\r\n\t\t}catch(e){\r\n\t\t\tconsole.log(e);\r\n\t\t}\r\n\t}\r\n\r\n\tcoord_text.append(\"text\")\r\n\t\t.text(time_text);\r\n\tcoord_text.append(\"text\")\r\n\t\t.attr(\"x\", 200)\r\n\t\t.text(type_text);\r\n\r\n\t// var Person_vertices = [];\r\n\t//for (i = 0; i < Coord_num; i++) {}\r\n\tfor (var field in fields) {\r\n\t\tvar i = fields[field];\r\n\t\tvar barName = Bar_name[i];\r\n\t\tvar Bar_svg = d3.select(\"#coord\")\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"transform\", \"translate(\" + (Bar_margin.left + Bar_len * i) + \",\" + Bar_margin.top + \")\");\r\n\r\n\t\tvar fieldRange = fieldRanges[field] && JSON.parse(fieldRanges[field]);\r\n\t\tvar ymin = fieldRange[0].toFixed(3), ymax = fieldRange[1].toFixed(3);\r\n\t\tBar_xdomain = [0, Bar_max[i]];\r\n\t\tBar_x.domain(Bar_xdomain);\r\n\r\n\r\n\t\t// 随机数\r\n\t\t// var j = parseInt(Math.random()*10);\r\n\t\t// while (Bar_data[i][j] == 0) j = parseInt(Math.random()*10);\r\n\t\t// Person_vertices[i] = [Bar_len*i, Bar_y(j) - Bar_height/20];\r\n\r\n\t\t//Bar X 轴\r\n\t\tBar_svg.append(\"g\")\r\n\t\t\t.attr(\"class\", \"x Bar_axis\")\r\n\t\t\t.attr(\"transform\", \"translate(0,\" + Bar_height + \")\")\r\n\t\t\t.style(\"opacity\",0)\r\n\t\t\t.call(Bar_xAxis)\r\n\t\t.append(\"text\")\r\n\t\t\t.attr(\"class\", \"label\")\r\n\t\t\t.attr(\"x\", Bar_width)\r\n\t\t\t.attr(\"y\", -6)\r\n\t\t\t.style(\"text-anchor\", \"end\")\r\n\t\t\t.text(\"\");\r\n\t\t//Bar Y 轴\r\n\t\t// Bar_y.domain([ymin, ymax]);\r\n\t\t// var Bar_yAxis2 = Bar_yAxis;\r\n\t\t// Bar_yAxis2.scale(Bar_y2).ticks(3);\r\n\t\t// Bar_yAxis.tickValues([ymin,ymin/2.0+ymax/2.0,ymax]);\r\n\t\tBar_svg.append(\"g\")\r\n\t\t\t.attr(\"id\", \"y_g\"+i)\r\n\t\t\t.attr(\"class\", \"y Bar_axis\")\r\n\t\t\t.call(Bar_yAxis)\r\n\t\t.append(\"text\")\r\n\t\t\t.attr(\"transform\", \"translate(\" + 30 + \",\" + (Bar_height + 7) + \")\")\r\n\t\t\t.attr(\"y\", 8)\r\n\t\t\t.style(\"text-anchor\", \"end\")\r\n\t\t\t.text(ymin);\r\n\t\t// Bar_y.domain([0, 10]);\r\n\t\td3.select(\"#y_g\"+i)\r\n\t\t.append(\"text\")\r\n\t\t\t.attr(\"transform\", \"translate(\" + 30 + \",\" + (-7) + \")\")\r\n\t\t\t.style(\"text-anchor\", \"end\")\r\n\t\t\t.text(ymax);\r\n\t\td3.select(\"#y_g\"+i)\r\n\t\t.append(\"line\")\r\n\t\t\t.attr(\"x1\", 0)\r\n\t\t\t.attr(\"y1\", 0)\r\n\t\t\t.attr(\"x2\", 0)\r\n\t\t\t.attr(\"y2\", Bar_height)\r\n\t\t\t.style(\"stroke\",\"grey\")\r\n\t\t\t.style(\"shape-rendering\",\"crispEdges\")\r\n\t\t\t.style(\"opacity\",0.3);\r\n\t\tfor (j = 0; j < 10; j++)\r\n\t\t{\r\n\t\t\td3.select(\"#y_g\"+i)\r\n\t\t.append(\"line\")\r\n\t\t\t.attr(\"x1\", -4)\r\n\t\t\t.attr(\"y1\", Bar_y(j))\r\n\t\t\t.attr(\"x2\", 0)\r\n\t\t\t.attr(\"y2\", Bar_y(j))\r\n\t\t\t.style(\"stroke\",\"grey\")\r\n\t\t\t.style(\"shape-rendering\",\"crispEdges\")\r\n\t\t\t.style(\"opacity\",0.3);\r\n\t\t}\r\n\t\tfor (j = 0; j < barName.length; j++)\r\n\t\t\td3.select(\"#y_g\"+i)\r\n\t\t\t.append(\"text\")\r\n\t\t\t\t.attr(\"transform\", \"translate(\" + (6 + (8-barName[j].length)*2) + \",\" + (Bar_height + 35 + 14*j) + \")\")\r\n\t\t\t\t.text(barName[j]);\r\n\r\n\t\tvar Rec_height = Bar_height/10;\r\n\t\t//Bar\r\n\t\tfor (j = 0; j < Bar_num; j++)\r\n\t\t{\r\n\t\t\tBar_svg.append(\"rect\")\r\n\t\t\t\t.attr(\"id\", \"Bar_rect\")\r\n\t\t\t\t.attr(\"class\", \"Bar_bar\")\r\n\t\t\t\t//.attr(\"fill\", fieldsColor[i])\r\n\t\t\t\t.attr(\"fill\", \"grey\")\r\n\t\t\t\t.attr(\"opacity\", util.opacityScale(0.1 * (j+1)))\r\n\t\t\t\t.attr(\"x\", 0)\r\n\t\t\t\t.attr(\"width\", Bar_x(Bar_data[i][j]) )\r\n\t\t\t\t.attr(\"y\", Bar_y(j) - Rec_height )\r\n\t\t\t\t.attr(\"height\", Rec_height);\r\n\t\t}\r\n\t}\r\n\r\n\t// 单个人轨迹\r\n\t// var line = d3.select(\"#coord\")\r\n\t// \t.append(\"g\")\r\n\t// \t.attr(\"transform\", \"translate(\" + Bar_margin.left + \",\" + Bar_margin.top + \")\");\r\n\t// for (var i = 1; i < 10; i++)\r\n\t// {\r\n\t// \tline.append(\"line\")\r\n\t// \t.style({\r\n\t// \t\tstroke: 'red',\r\n\t// \t\t\"stroke-width\": 2,\r\n\t// \t\topacity: 0.5\r\n\t// \t})\r\n\t// \t.attr(\"x1\", Person_vertices[i-1][0])\r\n\t// \t.attr(\"y1\", Person_vertices[i-1][1])\r\n\t// \t.attr(\"x2\", Person_vertices[i][0])\r\n\t// \t.attr(\"y2\", Person_vertices[i][1]);\r\n\t// }\r\n\r\n\t// 彩带\r\n\tvar Bar_vertices = [];\r\n\tfor (i = 0; i < Coord_num; i++)\r\n\t{\r\n\t\tvar j = 0;\r\n\t\twhile (Bar_data[i][j]==0 && j < Bar_num-1) j++;\r\n\t\tBar_vertices.push([Bar_len*i, Bar_y(j)]);\r\n\t\tif (i == Coord_num-1) Bar_vertices.push([Bar_len*i+Bar_width, Bar_y(j)]);\r\n\t}\r\n\tfor (i = Coord_num-1; i >= 0; i--)\r\n\t{\r\n\t\tvar j = Bar_num - 1;\r\n\t\twhile (Bar_data[i][j]==0 && j > 0) j--;\r\n\t\tif (i == Coord_num-1) Bar_vertices.push([Bar_len*i+Bar_width, Bar_y(j) - Rec_height]);\r\n\t\tBar_vertices.push([Bar_len*i, Bar_y(j) - Rec_height]);\r\n\t}\r\n\t// console.log(Bar_vertices);\r\n\t//d3.select(\"#coord\")\r\n\t//\t.append(\"g\")\r\n\t//\t.attr(\"transform\", \"translate(\" + Bar_margin.left + \",\" + Bar_margin.top + \")\")\r\n\t//\t.append('polygon')\r\n\t//\t.style({\r\n\t//\t\tfill: '#D3D3D3',\r\n\t//\t\topacity: 0.5\r\n\t//\t})\r\n\t//\t.attr('points',Bar_vertices);\r\n\r\n\t// head\r\n\tvar Bar_top_margin = {top: 0, right: 50, bottom: 0, left: 10},\r\n\t\tBar_top_width = coord_width,\r\n\t\tBar_top_height = coord_height/8;\r\n\r\n\tvar Bar_top_svg = d3.select(\"#coord\")\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"transform\", \"translate(\" + Bar_top_margin.left + \",\" + Bar_top_margin.top + \")\");\r\n\r\n}\r\n\r\n// render(\"body\");\r\nmodule.exports = render;\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./static/js/src/index/coordinates.js\n ** module id = 6\n ** module chunks = 1\n **/","var util = require(\"util\");\r\nvar coordinates = require(\"coordinates\");\r\nvar leafletmap, sankey;\r\n\r\nvar fieldsColors = [\"#a6cee3\", \"#1f78b4\", \"#b2df8a\", \"#33a02c\", \"#fb9a99\", \"#e31a1c\", \"#fdbf6f\", \"#ff7f00\", \"#cab2d6\", \"#6a3d9a\"];\r\n\r\nvar sortField = null;\r\nvar sortType = 0;\r\n\r\nfunction render(dom, map, san) {\r\n\r\n\tvar that = this;\r\n\r\n\tleafletmap = map;\r\n\tsankey = san;\r\n\r\n    var pix_width = $(dom).width(),\r\n        pix_height = pix_width/9*11.25;\r\n\r\n    var pix_left = pix_width/9*4;\r\n    pix_width = pix_width/9*5;\r\n\r\n    var gridSize = Math.floor(pix_width / 10),\r\n        colors = [\"#FFFAF0\",\"#FFDAB9\",\"#FFA07A\",\"#FF6347\",\"#EE2C2C\",\"#FF0000\"];\r\n\r\n    var pattern_num = 20;\r\n    var pattern = [];\r\n    var patternData = [];\r\n    var patternVal = [];\r\n    for (var i = 0; i < pattern_num; i++){\r\n        // pattern.push(\"Pattern\"+i);\r\n        pattern.push(+i);\r\n    }\r\n\r\n    //聚类序号，平均值\r\n    $.ajax({\r\n        type: 'GET',\r\n        async: false,\r\n        url: util.urlBase + '/getClusterAvg',\r\n        success: function(data){\r\n\t\t   //console.log(util.urlBase);\r\n\t\t   data.forEach(function(d){\r\n\t\t       patternData.push({\r\n\t\t\t\t  pat: d.clusterid,\r\n\t\t\t\t  dim: d.dimindex,\r\n\t\t\t\t  val: d.avgvalue\r\n\t\t       });\r\n\t\t   });\r\n        },\r\n        error: function(data){\r\n\t\t   console.log(data);\r\n        }\r\n    });\r\n  \t// 聚类\r\n    $.ajax({\r\n        type: 'GET',\r\n        async: false,\r\n        url: util.urlBase + '/getClusterPeople',\r\n        success: function(data){\r\n\t\t   \t//console.log(data);\r\n\t\t   \tdata.forEach(function(d){\r\n\t\t\t\tpatternVal.push({\r\n    \t\t\t\tpat: d.clusterid,\r\n    \t\t\t\tval: d.counts\r\n        \t\t});\r\n\t\t   });\r\n        },\r\n        error: function(data){\r\n\t\t   console.log(data);\r\n        }\r\n    });\r\n\r\n    // Ã¿¸öÀàÈËÊý\r\n    // for(var i = 0; i < pattern_num; i++){\r\n    //     patternVal.push({\r\n    // \t\tpat: i,\r\n    // \t\tval: Math.random() * 1000\r\n    //     });\r\n    // }\r\n\r\n\t$(\"#pixsvg\").remove();\r\n    var svg = d3.select(dom)\r\n        .append(\"svg\")\r\n        .attr(\"id\", \"pixsvg\")\r\n        .attr(\"width\", pix_width + pix_left + \"px\")\r\n        .attr(\"height\", pix_height + \"px\")\r\n        .append(\"g\")\r\n        .attr(\"id\", \"pix\")\r\n        .attr(\"transform\", \"translate(\"+ (-gridSize*0.75) +\",\" + gridSize*2.3 + \")\")\r\n        .append(\"g\")\r\n        .attr(\"transform\", \"translate(\" + (pix_left-gridSize) + \", 0)\");\r\n\r\n\tvar Dim_name = ['ETrand', 'Eunc',\r\n\t\t\t\t\t'AveSpeed', 'MoveDis',\r\n\t\t\t\t\t'Rg', 'MoveRatio',\r\n\t\t\t\t\t'AveLocX', 'AveLocY',\r\n\t\t\t\t\t'HomeLocX', 'HomeLocY'\r\n\t\t\t\t\t];\r\n\t// legend\r\n\td3.select(\"#pixsvg\")\r\n\t\t.append(\"g\")\r\n\t\t.attr(\"transform\", \"translate(\" + (pix_left - gridSize*2.25) + \",\" + gridSize*2.1 + \")\")\r\n\t\t.append(\"text\")\r\n\t\t.text(\"#Segments\")\r\n\t\t.attr(\"x\", 0)\r\n\t\t.attr(\"y\", 0)\r\n    \t.style({\r\n    \t\t\"font-family\": \"Arial\",\r\n    \t\t\"-webkit-text-size-adjust\": \"none\",\r\n    \t\t\"font-size\": \"5px\",\r\n    \t\t// \"fill\": \"gray\",\r\n    \t\t// \"opacity\": 0.5,\r\n    \t\t\"text-anchor\": \"end\"\r\n    \t});\r\n    d3.select(\"#pixsvg\")\r\n\t\t.append(\"g\")\r\n\t\t.attr(\"transform\", \"translate(\" + (pix_left - gridSize*5.5) + \",\" + gridSize*2.1 + \")\")\r\n\t\t.append(\"text\")\r\n\t\t.text(\"PatternID\")\r\n\t\t.attr(\"x\", 0)\r\n\t\t.attr(\"y\", 0)\r\n    \t.style({\r\n    \t\t\"font-family\": \"Arial\",\r\n    \t\t\"-webkit-text-size-adjust\": \"none\",\r\n    \t\t\"font-size\": \"5px\",\r\n    \t\t// \"fill\": \"gray\",\r\n    \t\t// \"opacity\": 0.5,\r\n    \t\t\"text-anchor\": \"end\"\r\n    \t});\r\n    for (var i = 0; i < Dim_name.length; i++)\r\n    {\r\n    \td3.select(\"#pixsvg\")\r\n    \t\t.append(\"g\")\r\n    \t\t.attr(\"transform\", \"translate(\" + (pix_left + gridSize*(i-1.25)) + \",\" + gridSize*2.3 + \")\")\r\n    \t\t.append(\"text\")\r\n    \t\t.text(Dim_name[i])\r\n    \t\t.attr(\"class\", \"features\")\r\n    \t\t.attr(\"x\", 0)\r\n    \t\t.attr(\"sort\", 0)\r\n    \t\t.attr(\"index\", i)\r\n    \t\t.attr(\"y\", 0)\r\n        \t.style({\r\n        \t\ttransform: \"rotate(-39deg)\",\r\n        \t\t\"font-family\": \"Arial\",\r\n        \t\t\"-webkit-text-size-adjust\": \"none\",\r\n        \t\t\"font-size\": \"5px\",\r\n        \t\t\"cursor\": \"pointer\",\r\n        \t\t// \"fill\": \"gray\",\r\n        \t\t// \"opacity\": 0.5,\r\n        \t\t\"text-anchor\": \"begin\"\r\n        \t}).on(\"click\", function(){\r\n\t\t\t\td3.selectAll(\".features\").attr(\"sort\", 0);\r\n\t\t\t\tvar sort = parseInt(d3.select(this).attr(\"sort\"));\r\n\t\t\t\tvar index = parseInt(d3.select(this).attr(\"index\"));\r\n\t\t\t\tsortField = index;\r\n\t\t\t\tif(sort === 0){\r\n\t\t\t\t\td3.select(this).attr(\"sort\", 1);\r\n\t\t\t\t\tsortType = 1;\r\n\t\t\t\t}\r\n\t\t\t\telse if(sort === 1){\r\n\t\t\t\t\td3.select(this).attr(\"sort\", 2);\r\n\t\t\t\t\tsortType = 2;\r\n\t\t\t\t}else if(sort === 2){\r\n\t\t\t\t\td3.select(this).attr(\"sort\", 1);\r\n\t\t\t\t\tsortType = 1;\r\n\t\t\t\t}\r\n\t\t\t\tsortPattern();\r\n\t\t\t});\r\n    }\r\n    svg.selectAll(\".pixLabel\")\r\n        .data(pattern)\r\n        .enter().append(\"text\")\r\n        .text(function (d) { return d; })\r\n        .attr(\"x\", -gridSize*1.15)\r\n        .attr(\"y\", function (d, i) { return i * gridSize; })\r\n        .style(\"text-anchor\", \"end\")\r\n        .attr(\"transform\", \"translate(\" + (-4*gridSize+5) + \",\" + gridSize/1.5 + \")\")\r\n        .attr(\"class\", \"pixLabel\")\r\n\t\t.attr(\"data\", function (d) { return d; })\r\n        .style(\"fill\",\"black\");\r\n\r\n    var pixChart = function(dd) {\r\n\r\n\t\t//console.log(patternData);\r\n        var colorScale = d3.scale.quantile()\r\n\t\t   .domain([0, 1, d3.max(patternData, function (d) { return d.val; })])\r\n\t\t   .range(colors);\r\n\r\n        svg.selectAll(\".dim.pixel\")\r\n\t\t   .data(patternData)\r\n\t\t   .enter().append(\"rect\")\r\n\t\t   .attr(\"x\", function(d) {\r\n\t\t\t   return d.dim * gridSize;\r\n\t\t   })\r\n\t\t   .attr(\"y\", function(d) {\r\n\t\t\t   return d.pat * gridSize;\r\n\t\t   })\r\n\t\t   .attr(\"data\", function(d){\r\n\t\t\t   return d.pat;\r\n\t\t\t})\r\n\t\t   .attr(\"rx\", 4)\r\n\t\t   .attr(\"ry\", 4)\r\n\t\t   .attr(\"class\", \"dim bordered pixel\")\r\n\t\t   .attr(\"width\", gridSize)\r\n\t\t   .attr(\"height\", gridSize)\r\n\t\t   //.style(\"fill\", function(d) {\r\n\t\t\t//   return colorScale(d.val);\r\n\t\t   //})\r\n\t\t\t//.style(\"fill\", function(d) {\r\n\t\t\t//\treturn fieldsColors[d.dim];\r\n\t\t\t//})\r\n\t\t\t.style(\"fill\", \"#e31a1c\")\r\n\t\t\t.style(\"opacity\", function(d) {\r\n\t\t\t\treturn d.val;\r\n\t\t\t})\r\n\t\t   .append(\"title\").text(function(d){\r\n\t\t       return d.val;\r\n\t\t   });\r\n\r\n        colorScale.domain([0, 1, d3.max(patternVal, function (d) { return d.val; })])\r\n        d3.select(\"#pix\")\r\n\t\t   .append(\"g\")\r\n\t\t   .attr(\"transform\", \"translate(\" + (pix_left/2-gridSize*0.4) + \", 0)\")\r\n\t\t   .selectAll(\".dim.total\")\r\n\t\t   .data(patternVal)\r\n\t\t   .enter().append(\"rect\")\r\n\t\t   .attr(\"x\", 0)\r\n\t\t   .attr(\"y\", function(d) { return d.pat * gridSize; })\r\n\t\t   .attr(\"data\", function(d) { return d.pat; })\r\n\t\t   .attr(\"rx\", 4)\r\n\t\t   .attr(\"ry\", 4)\r\n\t\t   .attr(\"class\", \"dim bordered total\")\r\n\t\t   .attr(\"width\", gridSize*3.2)\r\n\t\t   .attr(\"height\", gridSize)\r\n\t\t   //.style(\"fill\", function(d) { return colorScale(d.val);} )\r\n\t\t   .style(\"fill\", \"white\" )\r\n\t\t   .style(\"cursor\", \"pointer\")\r\n\t\t   .on(\"click\", function (d) {\r\n\t\t\t\tif(leafletmap.getBrushMode()){\r\n\t\t\t\t\td3.selectAll(\".pixRectFrame\")\r\n\t\t\t\t\t\t.style(\"fill\", \"none\");\r\n\t\t\t\t\td3.select(\"#RectFrame\"+d.pat)\r\n\t\t\t\t\t\t.style(\"fill\", \"#D3D3D3\");\r\n\t\t\t\t\tsankey.drawClusterStream(d.pat);\r\n\t\t\t\t\tcoordinates(\"#index-pcoordinates\", d.pat);\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t\tif(!sankey.locked){\r\n\t\t\t\t\td3.selectAll(\".pixRectFrame\")\r\n\t\t\t\t\t\t.style(\"fill\", \"none\");\r\n\t\t\t\t\td3.select(\"#RectFrame\"+d.pat)\r\n\t\t\t\t\t\t.style(\"fill\", \"#D3D3D3\");\r\n\t\t\t\t\tcoordinates(\"#index-pcoordinates\", d.pat);\r\n\t\t\t\t\tleafletmap.findTrajectory(d.pat);\r\n\t\t\t\t\tsankey.highlightCluster(d.pat);\r\n\t\t\t\t}\r\n\t\t   \t})\r\n\t\t   \t.on(\"mouseover\", function (d){\r\n\t\t       d3.select(\"#Frame\"+d.pat)\r\n\t\t\t\t  .style(\"opacity\", \"0.8\");\r\n\t\t   \t})\r\n\t\t   \t.on(\"mouseout\", function (d){\r\n\t\t       d3.select(\"#Frame\"+d.pat)\r\n\t\t\t\t  .style(\"opacity\", \"0\");\r\n\t\t   \t})\r\n\t\t   \t.append(\"text\")\r\n\t\t   \t.text(function(d) { return d.val;})\r\n\t\t   \t.style(\"pointer-events\", \"none\");\r\n\r\n\t\td3.select(\"#pix\")\r\n\t\t   .append(\"g\")\r\n\t\t   .attr(\"transform\", \"translate(\" + (pix_left/2-gridSize*0.4) + \", 0)\")\r\n\t\t   .selectAll(\".pixFrame\")\r\n\t\t   .data(pattern)\r\n\t\t   .enter().append(\"rect\")\r\n\t\t   .attr(\"id\", function (d, i) { return \"Frame\"+i; })\r\n\t\t   .attr(\"x\", 0)\r\n\t\t   .attr(\"y\", function (d, i) { return i * gridSize; })\r\n\t\t   .attr(\"rx\", 4)\r\n           .attr(\"ry\", 4)\r\n\t\t   .attr(\"width\", 13.4*gridSize)\r\n\t\t   .attr(\"height\", gridSize)\r\n\t\t   .attr(\"class\", \"pixFrame\")\r\n\t\t   .attr(\"data\", function (d, i) {\r\n\t\t\t\treturn d;\r\n\t\t\t})\r\n\t\t   .style(\"fill\", \"none\")\r\n\t\t   .style(\"stroke\", \"gray\")\r\n\t\t   .style(\"opacity\", \"0\");\r\n\r\n        d3.select(\"#pix\")\r\n           .append(\"g\")\r\n           .attr(\"transform\", \"translate(\" + (pix_left/2-gridSize*0.4) + \", 0)\")\r\n           .selectAll(\".pixRectFrame\")\r\n           .data(pattern)\r\n           .enter().append(\"rect\")\r\n           .attr(\"id\", function (d, i) { return \"RectFrame\"+i; })\r\n           .attr(\"x\", 0)\r\n           .attr(\"y\", function (d, i) { return i * gridSize; })\r\n           .attr(\"rx\", 4)\r\n           .attr(\"ry\", 4)\r\n           .attr(\"width\", 13.4*gridSize)\r\n           .attr(\"height\", gridSize)\r\n           .attr(\"class\", \"pixRectFrame\")\r\n           .attr(\"data\", function (d, i) {\r\n\t\t\t\treturn d;\r\n\t\t\t})\r\n           .style(\"fill\", \"none\")\r\n           .style(\"opacity\", \"0.6\")\r\n           .style(\"pointer-events\", \"none\");\r\n\r\n\t\td3.select(\"#pix\")\r\n\t\t   .append(\"g\")\r\n\t\t   .attr(\"transform\", \"translate(\" + (pix_left/2-gridSize*0.6) + \", 0)\")\r\n\t\t   .selectAll(\".pixTotal\")\r\n\t\t   .data(patternVal)\r\n\t\t   .enter().append(\"text\")\r\n\t\t   .text(function (d) { return parseInt(d.val); })\r\n\t\t   .style(\"pointer-events\", \"none\")\r\n\t\t   .attr(\"data\", function (d) { return parseInt(d.pat); })\r\n\t\t   .attr(\"x\", 0)\r\n\t\t   .attr(\"y\", function (d, i) { return i * gridSize; })\r\n\t\t   .attr(\"transform\", \"translate(\" + 20 + \",\" + gridSize/1.5 + \")\")\r\n\t\t   .attr(\"class\", \"pixTotal\");\r\n    };\r\n\r\n\tvar sortPattern = function(){\r\n\t\tpattern; //Pattern ID\r\n\t\tpatternData; //cluster people number\r\n\t\tpatternVal; //cluster-features data\r\n\t\tsortField;\r\n\t\tsortType;\r\n\t\t//console.log(patternData);\r\n\t\t//console.log(patternVal);\r\n\r\n\t\tif(sortField === undefined || sortType === 0){\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tvar sortArray = [];\r\n\t\tpatternData.forEach(function(d){\r\n\t\t\tif(d.dim === sortField){\r\n\t\t\t\tsortArray.push(d);\r\n\t\t\t}\r\n\t\t});\r\n\t\tsortArray.sort(function(a, b){\r\n\t\t\tif(sortType === 2){\r\n\t\t\t\treturn a.val - b.val;\r\n\t\t\t}else{\r\n\t\t\t\treturn b.val - a.val;\r\n\t\t\t}\r\n\t\t});\r\n\t\tconsole.log(sortArray);\r\n\t\tsortArray.forEach(function(d, i){\r\n\t\t\td3.select(\".pixLabel[data='\" + d.pat + \"']\")\r\n\t\t\t\t.attr(\"y\", i * gridSize);\r\n\t\t\td3.select(\".dim.total[data='\" + d.pat + \"']\")\r\n\t\t\t\t.attr(\"y\", i * gridSize);\r\n\t\t\td3.selectAll(\".dim.pixel[data='\" + d.pat + \"']\")\r\n\t\t\t\t.attr(\"y\", i * gridSize);\r\n\t\t\td3.selectAll(\".pixTotal[data='\" + d.pat + \"']\")\r\n\t\t\t\t.attr(\"y\", i * gridSize);\r\n\t\t\td3.select(\".pixFrame[data='\" + d.pat + \"']\")\r\n\t\t\t\t.attr(\"y\", i * gridSize);\r\n\t\t\td3.select(\".pixRectFrame[data='\" + d.pat + \"']\")\r\n\t\t\t\t.attr(\"y\", i * gridSize);\r\n\r\n\t\t});\r\n\r\n\t};\r\n\r\n    pixChart();\r\n\tsortPattern();\r\n\r\n}\r\n\r\n// render(\"bpdy\");\r\n\r\nmodule.exports = render;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./static/js/src/index/pixelmap.js\n ** module id = 7\n ** module chunks = 1\n **/"],"sourceRoot":""}